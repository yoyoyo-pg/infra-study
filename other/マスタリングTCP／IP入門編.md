# マスタリング TCP／IP 入門編

- [マスタリング TCP／IP 入門編](#マスタリング-tcpip-入門編)
  - [第 1 章 ネットワーク基礎知識](#第-1-章-ネットワーク基礎知識)
  - [第 2 章 TCP／IP 基礎知識](#第-2-章-tcpip-基礎知識)
    - [TCP／IP の成り立ち](#tcpip-の成り立ち)
    - [TCP／IP の標準化](#tcpip-の標準化)
    - [インターネットの基礎知識](#インターネットの基礎知識)
    - [TCP／IP の階層の補足](#tcpip-の階層の補足)
  - [第 3 章 データリンク](#第-3-章-データリンク)
    - [3.1 データリンクの役割](#31-データリンクの役割)
    - [3.2 データリンクの技術](#32-データリンクの技術)
      - [3.2.1 MAC アドレス](#321-mac-アドレス)
      - [3.2.2, 3.2.3 媒体共有型と、媒体非共有型のネットワーク](#322-323-媒体共有型と媒体非共有型のネットワーク)
      - [3.2.4 MAC アドレスによる転送](#324-mac-アドレスによる転送)
      - [3.2.6 VLAN](#326-vlan)
    - [3.3 イーサネット（Ethernet）](#33-イーサネットethernet)
      - [3.3.1 イーサネットの接続形態](#331-イーサネットの接続形態)
      - [3.3.2 イーサネットにはいろいろな種類がある](#332-イーサネットにはいろいろな種類がある)
      - [3.3.3 イーサネットの歴史](#333-イーサネットの歴史)
        - [IEEE802](#ieee802)
      - [3.3.4 イーサネットのフレームフォーマット](#334-イーサネットのフレームフォーマット)
    - [3.4 無線通信](#34-無線通信)
      - [3.4.1 無線通信の種類](#341-無線通信の種類)
      - [3.4.2 IEEE802.11](#342-ieee80211)
        - [CSMA/CA](#csmaca)
      - [3.4.3 IEEE802.11b、IEEE802.11g](#343-ieee80211bieee80211g)
      - [3.4.4 IEEE802.11a](#344-ieee80211a)
      - [3.4.7 IEEE802.11ax（Wi-Fi 6）](#347-ieee80211axwi-fi-6)
      - [3.4.8 無線 LAN を使用する場合の留意点](#348-無線-lan-を使用する場合の留意点)
      - [3.4.9 WiMAX](#349-wimax)
      - [3.4.10 Bluetooth](#3410-bluetooth)
    - [3.5 PPP（Point-to-Point Protocol）](#35-ppppoint-to-point-protocol)
      - [3.5.1 PPP とは](#351-ppp-とは)
    - [3.6 その他データリンク](#36-その他データリンク)
      - [3.6.7 HDMI](#367-hdmi)
    - [3.7 公衆アクセス網](#37-公衆アクセス網)
      - [3.7.1 アナログ電話回線](#371-アナログ電話回線)
      - [3.7.2 モバイル通信サービス](#372-モバイル通信サービス)
      - [3.7.5 ケーブルテレビ](#375-ケーブルテレビ)
      - [3.7.6 専用回線（専用線）](#376-専用回線専用線)
      - [3.7.7 VPN（Virtual Private Network）](#377-vpnvirtual-private-network)
        - [IP-VAN](#ip-van)
        - [広域イーサネット](#広域イーサネット)
      - [3.7.8 公衆無線 LAN](#378-公衆無線-lan)
  - [第 4 章 IP](#第-4-章-ip)
    - [4.1 IP はインターネット層のプロトコル](#41-ip-はインターネット層のプロトコル)
      - [4.1.1 IP は OSI 参照モデルの第 3 層に相当](#411-ip-は-osi-参照モデルの第-3-層に相当)
      - [4.1.2 ネットワーク層とデータリンク層の関係](#412-ネットワーク層とデータリンク層の関係)
    - [4.2 IP の基礎知識](#42-ip-の基礎知識)
      - [4.2.1 IP アドレスはネットワーク層のアドレス](#421-ip-アドレスはネットワーク層のアドレス)
      - [4.2.2 経路制御（ルーティング）](#422-経路制御ルーティング)
      - [4.2.3 データリンクの抽象化](#423-データリンクの抽象化)
      - [4.2.4 IP はコネクションレス型](#424-ip-はコネクションレス型)
    - [4.3 IP アドレスの基礎知識](#43-ip-アドレスの基礎知識)
      - [4.3.4 ブロードキャストアドレス](#434-ブロードキャストアドレス)
        - [2 つのブロードキャスト](#2-つのブロードキャスト)
      - [4.3.5 IP マルチキャスト](#435-ip-マルチキャスト)
      - [4.3.8 グローバルアドレスとプライベートアドレス](#438-グローバルアドレスとプライベートアドレス)
      - [4.3.9 グローバル IP アドレスは誰が決める](#439-グローバル-ip-アドレスは誰が決める)
    - [4.4 経路制御（ルーティング）](#44-経路制御ルーティング)
      - [4.4.1 IP アドレスと経路制御（ルーティング）](#441-ip-アドレスと経路制御ルーティング)
      - [4.4.2 経路制御表の集約](#442-経路制御表の集約)
    - [4.5 IP の分割処理と再構築処理](#45-ip-の分割処理と再構築処理)
      - [4.5.1 データリンクによって MTU は異なる](#451-データリンクによって-mtu-は異なる)
      - [4.5.2 IP データグラムの分割処理と再構築処理](#452-ip-データグラムの分割処理と再構築処理)
      - [4.5.3 経路 MTU 探索（Path MTU Discovery）](#453-経路-mtu-探索path-mtu-discovery)
    - [4.6 IPv6（IP version 6）](#46-ipv6ip-version-6)
    - [4.7 IPv4 ヘッダ](#47-ipv4-ヘッダ)
    - [4.8 IPv6 のヘッダフォーマット](#48-ipv6-のヘッダフォーマット)
  - [第 5 章 IP に関連する技術](#第-5-章-ip-に関連する技術)
    - [5.2 DNS（Domain Name System）](#52-dnsdomain-name-system)
      - [5.2.1 IP アドレスを覚えるのはたいへん](#521-ip-アドレスを覚えるのはたいへん)
      - [5.2.3 ドメイン名の構造](#523-ドメイン名の構造)
        - [ネームサーバー](#ネームサーバー)
    - [5.3 ARP（Address Resolution Protocol）](#53-arpaddress-resolution-protocol)
    - [5.4 ICMP（Internet Control Message Protocol）](#54-icmpinternet-control-message-protocol)
    - [5.5 DHCP（Dynamic Host Configuration Protocol）](#55-dhcpdynamic-host-configuration-protocol)
    - [5.6 NAT（Network Address Translator）](#56-natnetwork-address-translator)
      - [5.6.4 CGN（Carrier Grade NAT）](#564-cgncarrier-grade-nat)
    - [5.7 IP トンネリング](#57-ip-トンネリング)
    - [5.8 その他の IP 関連技術](#58-その他の-ip-関連技術)
      - [5.8.3 IP エニーキャスト](#583-ip-エニーキャスト)
      - [5.8.4 通信品質の制御](#584-通信品質の制御)
      - [5.8.6 Mobile IP](#586-mobile-ip)
  - [第 6 章 TCP と UDP](#第-6-章-tcp-と-udp)
    - [6.1 トランスポート層の役割](#61-トランスポート層の役割)
      - [6.1.1 トランスポート層とは](#611-トランスポート層とは)
      - [6.1.2 通信の処理](#612-通信の処理)
      - [6.1.3 2 つのトランスポートプロトコル TCP と UDP](#613-2-つのトランスポートプロトコル-tcp-と-udp)
        - [TCP](#tcp)
        - [UDP](#udp)
      - [6.1.4 TCP と UDP の使い分け](#614-tcp-と-udp-の使い分け)
    - [6.2 ポート番号](#62-ポート番号)
      - [6.2.4 ポート番号の決め方](#624-ポート番号の決め方)
        - [標準で決められている番号](#標準で決められている番号)
        - [ダイナミックな割り当て法](#ダイナミックな割り当て法)
      - [6.2.5 ポート番号とプロトコル](#625-ポート番号とプロトコル)
    - [6.3 TCP（Transmission Control Protocol）](#63-tcptransmission-control-protocol)
      - [6.4.1 TCP の目的と特徴](#641-tcp-の目的と特徴)
      - [6.4.2 シーケンス番号と確認応答で信頼性を提供](#642-シーケンス番号と確認応答で信頼性を提供)
      - [6.4.3 再送タイムアウトの決定](#643-再送タイムアウトの決定)
      - [6.4.4 コネクション管理](#644-コネクション管理)
      - [6.4.5 TCP はセグメント単位でデータを送信](#645-tcp-はセグメント単位でデータを送信)
      - [6.4.6 ウィンドウ制御で速度向上](#646-ウィンドウ制御で速度向上)
      - [6.4.7 ウィンドウ制御と再送制御](#647-ウィンドウ制御と再送制御)
      - [6.4.8 フロー制御（流量制御）](#648-フロー制御流量制御)
      - [6.4.9 輻輳制御（ネットワークの混雑解消）](#649-輻輳制御ネットワークの混雑解消)
      - [6.4.10 ネットワークの利用効率を高める仕組み](#6410-ネットワークの利用効率を高める仕組み)
      - [6.4.11 TCP を利用するアプリケーション](#6411-tcp-を利用するアプリケーション)
    - [6.5 その他のトランスポートプロトコル](#65-その他のトランスポートプロトコル)
      - [6.5.1 QUIC（QUIC UDP Internet Connections）](#651-quicquic-udp-internet-connections)
      - [6.5.2 SCTP（Stream Control Transmission Protocol）](#652-sctpstream-control-transmission-protocol)
      - [6.5.3 DCCP（Datagram Congestion Control Protocol）](#653-dccpdatagram-congestion-control-protocol)
      - [6.5.4 UDP-Lite（Liteweight User Dtagram Protocol）](#654-udp-liteliteweight-user-dtagram-protocol)
    - [6.6 UDP ヘッダのフォーマット](#66-udp-ヘッダのフォーマット)
      - [送信元ポート番号（UDP）](#送信元ポート番号udp)
      - [宛先ポート番号（UDP）](#宛先ポート番号udp)
      - [パケット長（UDP）](#パケット長udp)
      - [チェックサム（UDP）](#チェックサムudp)
    - [6.7 TCP ヘッダのフォーマット](#67-tcp-ヘッダのフォーマット)
      - [送信元ポート番号](#送信元ポート番号)
      - [宛先ポート番号](#宛先ポート番号)
      - [シーケンス番号](#シーケンス番号)
      - [確認応答番号](#確認応答番号)
      - [データオフセット](#データオフセット)
      - [予約](#予約)
      - [コントロールフラグ](#コントロールフラグ)
      - [ウィンドウサイズ](#ウィンドウサイズ)
      - [チェックサム](#チェックサム)
      - [緊急ポインタ](#緊急ポインタ)
      - [オプション](#オプション)
      - [パディング](#パディング)
  - [第 7 章 ルーティングプロトコル（経路制御プロトコル）](#第-7-章-ルーティングプロトコル経路制御プロトコル)
    - [7.1 経路制御（ルーティング）とは](#71-経路制御ルーティングとは)
    - [7.2 経路を制御する範囲](#72-経路を制御する範囲)
    - [7.3 経路制御アルゴリズム](#73-経路制御アルゴリズム)
    - [7.4 RIP](#74-rip)
    - [7.5 OSPF](#75-ospf)
    - [EIGPR](#eigpr)
    - [7.6 BGP](#76-bgp)
      - [7.6.1 BGP と AS 番号](#761-bgp-と-as-番号)
      - [7.6.2 BGP は経路ベクトル](#762-bgp-は経路ベクトル)
      - [個人的補足（Internet Week 2024 資料などより）](#個人的補足internet-week-2024-資料などより)
  - [第 8 章 アプリケーションプロトコル](#第-8-章-アプリケーションプロトコル)
    - [8.1 アプリケーションプロトコルの概要](#81-アプリケーションプロトコルの概要)
    - [8.2 遠隔ログイン（TELNET と SSH）](#82-遠隔ログインtelnet-と-ssh)
    - [8.3 ファイル転送（FTP）](#83-ファイル転送ftp)
      - [FTP について余談](#ftp-について余談)
    - [8.4 電子メール（E-Mail）](#84-電子メールe-mail)
      - [8.4.3 MIME（Multipurpose Internet MailExtensions）](#843-mimemultipurpose-internet-mailextensions)
      - [8.4.4 SMTP（Simple Mail Transfer Protocol）](#844-smtpsimple-mail-transfer-protocol)
      - [8.4.5 POP（Post Office Protocol）](#845-poppost-office-protocol)
      - [8.4.6 IMAP（Internet Message Access Protocol）](#846-imapinternet-message-access-protocol)
    - [8.5 WWW（World Wide Web）](#85-wwwworld-wide-web)
      - [8.5.3 URI（Uniform Resource Identifier）](#853-uriuniform-resource-identifier)
      - [スキーム](#スキーム)
      - [8.5.4 HTML（HyperText Markup Language）](#854-htmlhypertext-markup-language)
      - [8.5.5 HTTP（HyperText Transfer Protocol）](#855-httphypertext-transfer-protocol)
      - [8.5.6 Web アプリケーション](#856-web-アプリケーション)
    - [8.6 ネットワーク管理（SNMP）](#86-ネットワーク管理snmp)
      - [8.6.1 SNMP（Simple Network Management Protocol）](#861-snmpsimple-network-management-protocol)
      - [8.6.2 MIB（Management Information Base）](#862-mibmanagement-information-base)
    - [8.7 その他のアプリケーションプロトコル](#87-その他のアプリケーションプロトコル)
      - [8.7.1 マルチメディア通信を実現する技術（H.323、SIP、RTP）](#871-マルチメディア通信を実現する技術h323siprtp)
      - [8.7.2 P2P（Peer To Peer）](#872-p2ppeer-to-peer)
      - [8.7.3 LDAP（Lighitweight Directory Access Protocol）](#873-ldaplighitweight-directory-access-protocol)
      - [8.7.4 NTP（Network Time Protocol）](#874-ntpnetwork-time-protocol)
  - [第 9 章 セキュリティ](#第-9-章-セキュリティ)
    - [9.1 セキュリティの重要性](#91-セキュリティの重要性)
    - [9.2 セキュリティの構成要素](#92-セキュリティの構成要素)
      - [9.2.1 ファイアウォール](#921-ファイアウォール)
      - [9.2.2 IDS/IPS（侵入検知システム/侵入防止システム）](#922-idsips侵入検知システム侵入防止システム)
      - [9.2.3 アンチウイルス/パーソナルファイアウォール](#923-アンチウイルスパーソナルファイアウォール)

## 第 1 章 ネットワーク基礎知識

- ISO（国際標準化機構）が OSI 参照モデルを定めた
- TCP／IP は IETF（インターネット技術の標準化を推進する任意団体）で標準化がすすめられているプロトコル
- SNS で文書を送る例を基に、OSI 参照モデルの各層を解説
  - アプリケーション層・・・メッセージ、宛先の情報
  - プレゼンテーション層・・・ネットワーク全体で統一された表現形式 ⇔ コンピュータやソフトウェアに適した表現形式の変換をする
    - 符号化形式・・・UTF-8、Shift_JIS など
  - セッション層・・・どんなコネクションを使って転送するか、データ転送自体の機能は持たない
  - トランスポート層・・・コネクションの確立や切断
  - ネットワーク層・・・ネットワーク間の接続がある環境で、ホスト間のデータの受け渡しを行う。IP アドレスが必要
  - データリンク、物理層・・・MAC アドレスが指定。物理マシンの一区間ごとにパケットのヘッダとして付与
- 通信方式の種類
  - コネクション型とコネクションレス型・・・コネクションレス型はコネクションを確立せずに送信
  - 回線交換とパケット交換・・・パケット交換ではパケット交換機（ルーター）によって通信回線が結ばれる
    - ルーターの中にはバッファと呼ばれる記憶領域があり、パケットは一旦ここに格納されるが、大量のパケットが流れると溢れてパケットロスになる
- IP アドレスと MAC アドレス
- IP アドレスは階層性があるが、MAC アドレスには階層性が無い
- ネットワークの途中にある通過点では、各パケットのアドレスを見てどのネットワークインターフェースから送り出すかを決める
  - そのためにアドレスごとに送出インターフェースを記したテーブルを参照する
  - MAC アドレスの場合は転送表（フォワーディングテーブル）と言い、IP アドレスの場合は経路制御表（ルーティングテーブル）

## 第 2 章 TCP／IP 基礎知識

### TCP／IP の成り立ち

- 1960 年代に、大学や各研究所で新しい通信技術の研究が行われるように
- 1960 年代後半には、パケット交換技術・パケット通信に注目するように
  - 分散型のネットワークであれば、攻撃を受けても迂回路がある限り通信を継続できる
  - また、パケット通信を利用することで、複数のユーザーで同時に一つの回線を共有することができ、回線の利用効率が向上する
- 1969 年に、ARPANET（アーパネット）と呼ばれるネットワークが構築された
  - パケット通信の実用性の試験がされ、ARPANET はインターネットの起源とされている
- 1975 年に、ARPANET 内の研究グループによって TCP／IP が誕生
- 1980 年代は大学や研究所などで LAN が発達するとともに UNIX の普及が急速に進み、同時に TCP／IP によるネッワーク構築が盛んにおこなわれるように
  - TCP／IP による世界的なネットワークを「インターネット」と呼ぶようになったのはこの頃から
- 1990 年代は企業や一般家庭に対して、ISP（インターネットサービスプロバイダ）がインターネットへの接続を提供するように

### TCP／IP の標準化

- 多くの場合、TCP／IP は TCP と IP だけでなく、プロトコル群の総称として使われる
- 標準化については、他の標準化と比べると２つの点が大きく異なる
  - IETF のオープンな議論を通して決められる
  - 実際に使えるプロトコルであるかが重視される
- 標準化しようとするプロトコルは RFC（Request For Comments）として番号が割り振られ、ドキュメントとして IETF の ftp および web サーバを通じて閲覧可能となる

※全然関係ないが、ひたすら Qiita に joke-rfc を纏めている方を発見した
<https://qiita.com/yoshi389111>

### インターネットの基礎知識

- 現在、インターネットというと ARPANET（アーパネット）から発展し、全世界を接続しているコンピュータネットワークを指す
- インターネットと TCP／IP の関係として、インターネットのプロトコルと言えば TCP／IP ということになる
- ISP や地域ネットワークに属する形で、組織や家庭のネットワークが存在している
- ネットワーク同士は NOC（Network Operation Center）で接続される
- ネットワーク運用者や運用方針が異なるネットワークを対等に接続するポイントは IX（Internet Exchange）と- ばれる
- NOC とは、ISP 等が地域ごとに設ける運用拠点を指すことが多い
- <https://e-words.jp/w/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%BB%E3%83%B3%E3%82%BF%E3%83%BC.html>

### TCP／IP の階層の補足

- ネットワーク層（インターネット層）
  - インターネットは、インターネット層の機能を備えたネットワーク（要はデータリンク層、物理層は抽象化される）
  - インターネットに接続される全てのホストやルーターは必ず IP の機能を実装しなければならない
- トランスポート層
  - アプリケーションプログラム間の通信を実現する
- アプリケーション層
  - アプリケーションプログラムの中で実現される
- パケットの送信例
  - 各階層では送信されるデータにヘッダと呼ばれる情報が付加される
  - イーサネットヘッダ、IP ヘッダ、TCP ヘッダ
  - それぞれのヘッダには少なくとも「宛先と送信元のアドレス」と「上位層のプロトコルが何かを示す情報」が入っている

## 第 3 章 データリンク

### 3.1 データリンクの役割

- TCP／IP では、データリンク層と物理層が透過的に機能していることを前提にしている
- データリンクとは、直接的に接続されているコンピュータ間の通信を可能にするプロトコル
- この章では、MAC アドレス、スイッチング技術、ループ検出、VLAN、無線 LAN、PPP 等について紹介する
- データリンクのセグメントについて
  - 区切られた 1 つのネットワークという意味でセグメントが使われる
  - 例えばリピーターを介して 2 つのケーブルを接続している例だと、物理層の観点から見ると 1 つのケーブルで 1 セグメントだが、ネットワーク層の観点から見ると、1 セグメントと見なされる

### 3.2 データリンクの技術

#### 3.2.1 MAC アドレス

- MAC アドレスはイーサネットや無線 LAN、Bluetooth でも使われる
  - 48 ビット長で、ベンダ識別子とベンダ内の識別子で構成され世界中で唯一となる
  - ただし、同じデータリンク内に同一の MAC アドレスが存在しなければいいという話なので、絶対に唯一の値とは限らない
  - ベンダ識別子は IEEE が割り当てる
    - 00-00-0E は富士通、という形で割り当てられている
    - [MAC ベンダー検索くん](http://mobile.shinsv.mydns.jp/tech/mac_address/cm.html)

#### 3.2.2, 3.2.3 媒体共有型と、媒体非共有型のネットワーク

- 媒体共有型
  - 通信媒体を複数のノードで共有する
  - 基本的には半二重通信となり、通信の優先権を制御する仕組みが必要
- 媒体非共有型
  - 通信媒体を共有せずに占有する方式
  - スイッチに接続し、スイッチがフレームを転送する
  - 全二重通信が可能で、送受信を同時に行える

#### 3.2.4 MAC アドレスによる転送

- 媒体非共有型で利用されていたスイッチ技術をイーサネットで利用できるようにしたのがスイッチングハブやイーサネットスイッチ
- スイッチの送出インターフェース（ポート）と MAC アドレスを記したテーブルを転送表といい、スイッチで自動的に生成される
  - どのホストがどのインターフェースに接続されているかは、パケットの送受信で判明し、転送表に書き込む
  - これをスイッチでの自己学習という
- MAC アドレスに階層性はないので、転送表のエントリにはそのデータリンク内に存在する機器の数だけ必要
  - 転送表の検索にかかる時間も長くなるので、たくさんの端末をつなげる場合は複数のデータリンクに分ける

#### 3.2.6 VLAN

- スイッチのポートごとにセグメントを分けることで、ブロードキャストのトラフィックが流れる範囲を区切れる
- 異なるセグメント間で通信を行うには、ルーターの機能を備えたスイッチ（L3）を利用するか、セグメント間をルーターで結ぶ必要がある

### 3.3 イーサネット（Ethernet）

- データリンクで現在最も普及しているのがイーサネット
- 制御の仕組みが単純で、ほかのデータリンクよりも NIC やデバイスドライバが作りやすく、低価格で利用できたことがイーサネット普及の大きな要因でもある

#### 3.3.1 イーサネットの接続形態

- イーサネット普及当初は同軸ケーブルを利用する媒体共有型の接続が一般的
- 現在では、端末とスイッチの間を占有のケーブルで接続する形に

#### 3.3.2 イーサネットにはいろいろな種類がある

- 10BASE,100BASE,1000BASE,10GBASE とあるが、それぞれ 10Mbps,100Mbps,1Gbps,10Gbps といった伝送速度を意味している
- 後ろに 5,2,T,F などの文字が入るが、これは媒体の違いを意味している

#### 3.3.3 イーサネットの歴史

- イーサネットは同軸ケーブルを使う 10BASE5 が最初に規格化された
- 歴史的には多様なイーサネットがあるが、いずれも IEEE802.3 分科会で標準化されている

##### IEEE802

- IEEE（The Institute of Electrical and Electronics Engineers：米国電気電子技術者協会）委員会では、様々な LAN 技術の標準化を進めている
- 802 という数字は 1980 年 2 月に Lan の標準化のプロジェクトが始まったことに由来している

#### 3.3.4 イーサネットのフレームフォーマット

- イーサネットフレームの先頭には 1 と 0 を交互に並べたプリアンプルと呼ばれるフィールドが付けられる
- フレームの中には MAC アドレス、データ、FCS（フレームが壊れていないかチェックするためのフィールド）がある

### 3.4 無線通信

- 電波や赤外線、レーザー光線などを利用する
- 無線通信の中でオフィス内のような LAN の範囲を比較的高速で接続する物を無線 LAN と呼ぶ

#### 3.4.1 無線通信の種類

- 通信距離に応じて、分類が出来る
- IEEE802 委員会で、PAN~RAN の規格化が進められている

| 短距離無線 | 規格化団体             | 技術名称        |
| ---------- | ---------------------- | --------------- |
| 短距離無線 | 個別                   | RF-ID           |
| 無線 PAN   | IEEE802.15             | Bluetooth       |
| 無線 LAN   | IEEE802.11             | Wi-Fi           |
| 無線 MAN   | IEEE802.16, IEEE802.20 | WiMAX           |
| 無線 RAN   | IEEE802.22             | ---             |
| 無線 WAN   | 3GPP                   | 3G, LTE, 4G, 5G |

#### 3.4.2 IEEE802.11

- 多くの規格の総称として用いられる場合と、無線 LAN の一通信方式として用いられる場合がある
- 一通信方式の IEEE802.11 としては、物理層で電波もしくは赤外線を用いて、1Mbps もしくは 2Mbps の通信速度を実現する規格（後発の規格に劣るため、ほとんど利用されていない）

##### CSMA/CA

- 無線 LAN が利用する電波は有限なので、媒体共有型のネットワーク
- イーサネットで採用されている CSMA/CD と似た CSMA/CA というアクセス制御方式を採用している
  - データを送信してよい状態か確認し、ランダムな時間待ってからデータ送信を開始することで衝突を回避

#### 3.4.3 IEEE802.11b、IEEE802.11g

- 2.4GHz 帯の電波を利用
- 最大 11Mbps および 54Mbps

#### 3.4.4 IEEE802.11a

- 5GHz 帯の電波を利用
- 最大 54Mbps

※IEEE802.11n,IEEE802.11ac は省略

#### 3.4.7 IEEE802.11ax（Wi-Fi 6）

- 2.4GHz または 5GHz 帯を利用
- 最大 9.6Gbps の伝送速度を実現

#### 3.4.8 無線 LAN を使用する場合の留意点

- 2018 年に WPA3（鍵長 128/192bit）が登場したが、それまでは WPA2（AES ベース、鍵長 128bit）
- 電子レンジを動作させると 2.4GHz 帯の転送能力が著しく低下する場合

#### 3.4.9 WiMAX

- Worldwide Interoperability for Microwave Access の略
- マイクロ波を使って企業や自宅への無線接続を行う方式
- 無線 MAN に属し、大都市圏をエリアとする広範囲なワイヤレスネットワークをサポートする

#### 3.4.10 Bluetooth

- IEEE802.11b/g などと同じ 2.4GHz 帯を使って通信する
- Bluetooth4.0 では低消費電力を実現する Bluetooth Low Energy が策定され、IoT デバイスなどで活用されている

※ZigBee、LPWA は省略

### 3.5 PPP（Point-to-Point Protocol）

#### 3.5.1 PPP とは

- 1 対 1 でコンピュータを接続するためのプロトコル
- イーサネットや FDDi はデータリンク層、物理層に関係していたが、PPP は純粋なデータリンクのプロトコル
- 電話回線や ISDN、専用線などで利用されている
- ADSL やケーブルテレビなどを使ったインターネット接続で PPPoE（PPP over Ethernet）として利用されるように
  - 家庭内 LAN やルータなどの機器と、ISP 内に設置された通信機器の間で接続を確立する手段として利用される

> [!NOTE]
> 近年ではイーサネットを前提とした IPoE が登場し、ネットワーク終端装置を必要とせずにインターネットに接続できる場合も

※LCP と NCP、PPP のフレームフォーマット、PPPeE は省略

### 3.6 その他データリンク

※ATM、POS、ファイバーチャネル、iSCSI、InfiniBand、IEEE1394、DOCSIS、高速 PLC は省略

#### 3.6.7 HDMI

- 2009 年に公開されたバージョン 1.4 からイーサネットのフレームを伝送する企画が追加
- HDMI ケーブルを使って TCP/IP による通信が可能に

### 3.7 公衆アクセス網

- LAN などのような構内の接続ではなく、外部と接続する場合に使用する公衆通信サービスについて解説
- 公衆通信サービスとは、NTT や KDDI、ソフトバンクなどの通信事業者に料金を払って通信回線を借りる形態

#### 3.7.1 アナログ電話回線

- いわゆる固定電話回線を利用して通信を行う
- 特別な通信回線を必要とせず、一般家庭に広く普及している電話網をそのまま利用できる
- 現在はほとんど利用されていない

#### 3.7.2 モバイル通信サービス

- 1G,2G,PHS,3G,4G-LTE と規格化が進んでいる
- 5G は上り 480Mbps、下り最大 10〜20Gbps ほど

※ADSL と FTTH は省略

#### 3.7.5 ケーブルテレビ

- 電波を使うテレビ放送をケーブルを使って放送
- ケーブルテレビを使ったインターネット接続サービスが広く行われるように
  - 放送に使われていない空いているチャンネルをデータ通信専用に利用
- インターネットへの接続は加入者宅からケーブルモデムで信号変換され、ケーブルテレビ網を通り ISP に接続される

#### 3.7.6 専用回線（専用線）

- イーサネット専用線サービスなど

#### 3.7.7 VPN（Virtual Private Network）

- VPN サービスには IP-VPN、広域イーサネットがある

##### IP-VAN

- IP ネットワークに VPN を構築する
- MPLS(Multiprotocol Label Switching)技術を用いて、パケットへのラベル付けにより通信事業者のネットワーク内に仮想的な独自ネットワークを作り上げる
- IP-VPN サービス以外にも、企業が独自にインターネット上に VPN を構築する場合もある、IPsec により実現する方法が一般的になっている（IPsec については九章で解説）

##### 広域イーサネット

- IP-VPN が IP 層での接続サービスであるのに対して、広域イーサネットはデータリンク層であるイーサネットを用いた VLAN（バーチャル LAN）を利用する
- イーサネットをそのまま利用するので、TCP/IP 以外のプロトコルも利用できる
- 広域イーサネットは通信事業者が構築する VLAN を、利用企業が専用で利用する形になるので、不要なパケットを流さないように利用者が工夫した上で運用することが必要に

#### 3.7.8 公衆無線 LAN

- Wi-Fi（IEEE802.11b など）を利用したサービス

※その他の公衆通信サービスは省略

## 第 4 章 IP

- この章では IP について説明

### 4.1 IP はインターネット層のプロトコル

#### 4.1.1 IP は OSI 参照モデルの第 3 層に相当

- IP は OSI 参照モデルの第 3 層のネットワークに相当する
- ネットワーク層の役割は「終点ノード間の通信を実現する」こと
- データリンクを超えた通信をするためにはネットワーク層が必要

#### 4.1.2 ネットワーク層とデータリンク層の関係

- データリンク層は 1 区間の通信を実現するのに対して、ネットワーク層は最終目的地までの通信を実現する
- 旅行で言う所の、切符や航空券がデータリンク層で、旅行の行程表がネットワーク層

### 4.2 IP の基礎知識

#### 4.2.1 IP アドレスはネットワーク層のアドレス

- IP アドレスの形式は、ホストがどのような種類のデータリンクに接続されていても、全く同じものが使われる
- イーサネットも、無線 LAN も、PPP でも、IP アドレスの形式は同じ
- ネットワーク層には、データリンク層の性質を抽象化する役割がある
- TCP/IP で通信するすべてのホストやルーターには、必ず IP アドレスを設定する必要がある
  - ブリッジやスイッチングハブなど、物理層やデータリンク層でパケットを中継する機器には設定する必要はない

#### 4.2.2 経路制御（ルーティング）

- 経路制御とは、宛先 IP アドレスのホストまでパケットを届けるための仕組み
- TCP/IP では、ネットワークの 1 区間を IP パケットが跳ぶことをホップという
  - ここでの 1 ホップは送信元 MAC アドレスから宛先 MAC アドレスのでフレームが転送される区間を指す
  - それぞれの区間（ホップ）ごとに個々のルーターが IP パケットの転送処理を行い、最終的な宛先ホストにパケットがたどり着く
- すべてのホストやルーターは経路制御表（ルーティングテーブル）を持っている

#### 4.2.3 データリンクの抽象化

- IP は複数のデータリンクで接続されたネットワーク間の通信を実現する
- IP から見て、データリンク間で異なるのは最大転送速度（MTU：Maximum Transmission Unit）
  - ただ、IP より上位層でこの MTU よりも大きなパケット長の送信要求がくるかもしれず、この問題に対処するために IP では分割処理（フラグメンテーション）を行い、IP パケットを分割する

#### 4.2.4 IP はコネクションレス型

- コネクションレス型なので、パケットを送信する前に通信相手との間にコネクションの確立を行わない
  - これは機能の簡略化と高速化のためであり、パケットの取りこぼしなど無駄な通信をする可能性もある
  - 信頼性を高めるのは上位層の TCP の役目で、こちらはコネクション型となる
- IP は最善努力型（ベストエフォート）のサービスと呼ばれる

### 4.3 IP アドレスの基礎知識

- IP パケットが途中のルーターで転送されるときには、宛先 IP アドレスのネットワーク部が利用される
- ネットワーク部は同一セグメント内では同じ値にし、ホスト部は同一セグメント内で違う値とする

#### 4.3.4 ブロードキャストアドレス

- 各ネットワーク（サブネット）の最後のアドレス（ホスト部の全ビットが「1」）をブロードキャストアドレスと呼ぶ
- 172.20.0.0/16 の場合は、172.20.255.255 がブロードキャストアドレス
- ブロードキャストを必要としないホストは、IP より上位の層でパケットを廃棄する

##### 2 つのブロードキャスト

- ローカルブロードキャストとダイレクトブロードキャストがある
- ローカルブロードキャストは、自分が属しているリンク内ブロードキャストのこと
- ダイレクトブロードキャストは、異なる IP ネットワークのブロードキャストアドレスにブロードキャストすること
  - ただしセキュリティ上の問題があるため、ルーターで転送されないように設定されている場合が多い

#### 4.3.5 IP マルチキャスト

- 特定のグループに所属するすべてのホストにパケットを送信するために利用される
- 範囲は 224.0.0.0/4（224.0.0.0 から 224.255.255.255 まで）

#### 4.3.8 グローバルアドレスとプライベートアドレス

- プライベートアドレスは次の範囲
  - `10. 0.  0.  0` 　～　 `10. 255. 255. 255`
  - `172. 16. 0. 0` 　～　 `172. 31. 255. 255`
  - `192. 168. 0. 0` 　～　 `192. 168. 255. 255`
- この範囲外の IP アドレスはグローバル IP アドレスと呼ばれる

#### 4.3.9 グローバル IP アドレスは誰が決める

- ICANN（Internet Corporation for Assigned Names and Numbers）で一元管理されている
- 日本では JPNIC（Japan Network Information Center）がグローバル IP アドレスの割り当て機関として活動している
- 現在はユーザーが ISP にインターネットの接続を依頼するとき、ISP がユーザーに代わって JPNIC にアドレス割り当てを申請することになる

### 4.4 経路制御（ルーティング）

- IP において、ホストやルーターは経路制御表（ルーティングテーブル）をもとにパケットの送信先を決定する
- 管理者が事前に設定する方法をスタティックルーティング（静的経路制御）、ルーターが他のルーターと情報を交換して自動的に作成する方法をダイナミックルーティング（動的経路制御）と呼ぶ

#### 4.4.1 IP アドレスと経路制御（ルーティング）

- 経路制御表には、ネットワークアドレスと次に配送すべきルーターのアドレスが書かれている
- デフォルトルート
  - 経路制御表のどのアドレスにもマッチしない場合はデフォルトルートへ流れる
  - デフォルトルートは 0.0.0.0/0、または default と記述する
- ホストルート
  - IP アドレス/32（ex 192.168.153.15/32）はホストルートと呼ばれる
  - このホストルートを利用すると、IP アドレスのネットワーク部ではなくネットワークインターフェースにつけた IP アドレスそのものに基づいて経路制御が行われる
- ループバックアドレス
  - 同一コンピュータ内で通信したい場合に利用される
  - 127.0.0.1 という IP アドレス、または localhost というホスト名が利用される
  - このアドレスを利用した場合、パケットはネットワークには流れない
- リンクローカルアドレス
  - ルーターを超えない同一リンク内での通信に利用される
  - 169.254/16 という IP アドレス
  - 固定 IP が設定されていないホストで、DHCP による IP アドレスの取得が出来なかった時に設定されることがある

#### 4.4.2 経路制御表の集約

- 経路制御表が大きくなると、その管理にメモリ空間や CPU が必要になる他、検索に時間がかかり IP パケットの転送能力が低下する
- 大規模なネットワークを構築する場合は、経路制御表をいかにして小さく保つかが課題の一つとなる

### 4.5 IP の分割処理と再構築処理

#### 4.5.1 データリンクによって MTU は異なる

- MTU（最大転送単位）はデータリンクによって異なる
- IP はデータリンクの上位層として、MTU に左右されることなく利用できなければならない

#### 4.5.2 IP データグラムの分割処理と再構築処理

- IP ヘッダには分割された断片の位置とそのパケットの後に断片が続いていることを示すフラグがある
  - このフラグで、IP データグラムが分割されていることと、断片の始まりか、中間か、終わりかが分かる
- 分割された IP データグラムを元の IP データグラムに戻す処理は終点の宛先ホストだけで行われる
  - 途中でデータを失ったり、再び分割が必要になる可能性を考慮し、終点で再構築処理を行うようになっている

#### 4.5.3 経路 MTU 探索（Path MTU Discovery）

- 経路 MTU とは、送信先ホストから宛先ホストまで分割処理が必要にならない最大の MTU のこと
  - つまり、経路に存在するデータリンクの最小の MTU
- 経路 MTU 探索とは
  - 分割処理はルーターの負荷がかかり、データが失われるリスクも上がることから、経路 MTU を発見し送信元ホストで経路 MTU の大きさにデータを分割して送信する方法
  - 最近の多くの OS で実装されるようになった

### 4.6 IPv6（IP version 6）

### 4.7 IPv4 ヘッダ

### 4.8 IPv6 のヘッダフォーマット

## 第 5 章 IP に関連する技術

この章では IP を支える様々な関連技術について説明します（DNS、ARP、ICMP、DHCP、NAT）

### 5.2 DNS（Domain Name System）

#### 5.2.1 IP アドレスを覚えるのはたいへん

- ARPANET では、当初は hosts ファイルをネットワークインフォメーションセンター（SRI-NIC）で一括管理していた

#### 5.2.3 ドメイン名の構造

- ドメイン名は長い間 ASCII 文字しか使えなかったが、現在では日本語など多国語に対応している
  - 追加で調べたこと：DNS は日本語に対応していないので、日本語は一度「ピュニコード（Punycode）」に変換される

##### ネームサーバー

- ドメイン名を管理しているホストやソフトウェアのこと
- ネームサーバーは、そのネームサーバーが設置された階層のドメインに関する情報を管理する
  - それぞれのネームサーバーは下の階層のネームサーバーの IP を知っており、ルートからネームサーバーが木構造の様に結ばれている

### 5.3 ARP（Address Resolution Protocol）

- アドレス解決のためのプロトコル
- 宛先ホストが同一リンク上にない場合に、次ホップのルーターの MAC アドレスを ARP で調べることになる
  - IPv6 では ARP の代わりに ICMPv6 の近隣探索メッセージが利用される
- ARP 要求パケットと応答パケット
  - 宛先の IP は分かるが、MAC アドレスが分からない場合、ARP 要求パケットをブロードキャストする
  - ARP 要求パケットにより、宛先の IP に対応する MAC アドレスを埋めて返すのが ARP 応答パケット
- 通常 ARP により取得した MAC アドレスは数分間キャッシュされる
- IP アドレスと MAC アドレスの対応関係を記憶するデータベースを ARP テーブルと呼び、`arp -a`で内容を表示できる
- IP アドレスと MAC アドレスの両方が分からないと、パケットの配送はできない
  - MAC アドレスだけだと、別リンクのホストに配送できない
  - IP アドレスだけだと、経由先のルーターを示す情報が無い

### 5.4 ICMP（Internet Control Message Protocol）

- IP パケットが目的のホストまで届くかどうかを確認する機能など、トラブルシューティングに役立つのが ICMP
- ICMP による情報の通知は IP を使って配送される
- ICMP には、大きく分類すると「エラー通知のためのエラーメッセージ」と「診断などを行う問い合せメッセージ」の 2 種類がある
- IP パケットの TTL による破棄が行われた場合、IP ルーターは ICMP 時間超過メッセージのコード 0 を送信元に送り返し、パケットが破棄されたことを通知する
  - この仕組みを利用したのが`traceroute`（`tracert`）で、宛先ホストに到達するまでに、どのようなルーターを通過するかを表示してくれる
- IPv4 においては、ICMP は補助的な役割だが、IPv6 においては ICMP の役割が大きくなる
  - IP アドレスから MAC アドレスを調べるプロトコルが ARP から ICMP の近隣探索メッセージに変更される

### 5.5 DHCP（Dynamic Host Configuration Protocol）

- 個々の端末（DHCP クライアント）に対する IP アドレスの設定の自動化や、配布する IP アドレスの一括管理を行うために DHCP が利用される
- DHCP サーバーがあることで、ネットワークに接続すると TCP/IP の通信に必要な設定が行われる
  - そのセグメントのルーターが DHCP サーバーになることも多い
- DHCP で IP アドレスを取得する際は、IP アドレスの設定要求後、IP アドレスの設定使用の要求の 2 段階に分かれる
  - これは、DHCP サーバーを 2 つ以上設置しても正しく動作するようにするため
  - DHCP サーバーに障害が発生すると IP アドレスが配られなくなるため、複数の DHCP サーバーを起動することが奨励されている
- DHCP リレーエージェントを使うことで、複数の異なるセグメントの IP アドレスの割り当てを一つの DHCP サーバーで管理・運用できます。

### 5.6 NAT（Network Address Translator）

- 現在は単に NAT といっても NAPT のことを指すのが普通
- モバイルルーターやスマートフォンのテザリング（インターネット共有）も、NAPT によるもの
- TCP や UDP を利用した通信の場合、「宛先 IP アドレス」「送信元 IP アドレス」「宛先ポート番号」「送信元ポート番号」「TCP による通信か UDP による通信かを表すプロトコル番号」の 5 つの識別子が同じでなければ同一の通信とはみなされない
  - これを利用したのが NAPT
- NAT（NAPT）対応ルーターの内部では、送信元 IP アドレスとグローバル IP アドレスを変換するための変換テーブルが自動的に作成される

#### 5.6.4 CGN（Carrier Grade NAT）

- LSN（Large Scale NAT）とも呼ばれる
- ISP レベルで NAT を行う技術で、2 段階の NAT となっている
  - 1 段目（ISP の CGN）
    - ISP が各組織に配布したプライベート IP アドレス とグローバル IP アドレスの変換
  - 2 段目（各組織の NAT）
    - 各組織のプライベート IP アドレスと ISP が各組織に配布したプライベート IP アドレス

:::note info
CGN はポート番号の枯渇問題がある  
AWS だと、マルチキャストやブロードキャストが出来ない  
traceroute（tracert）は Windows の場合は ICMP だが、linux の場合は UDP で送っているなど違いが存在する  
:::

### 5.7 IP トンネリング

- あるネットワーク A と B で IPv4 が使われていて、その間の C で IPv6 しかサポートしていない場合に、IP トンネリングが使われる
- ネットワーク層のヘッダの次にまたネットワーク層のヘッダが続く形
  - 具体的には「IPv4 ヘッダの次に IPv6 ヘッダ」など
- トンネリングを使用すると、追加されるヘッダの分だけ MTU が小さくなる

### 5.8 その他の IP 関連技術

#### 5.8.3 IP エニーキャスト

- IP エニーキャストとは、同じサービスを提供するサーバーに同じ IP アドレスをつけて、日本なら日本のサーバー、米国なら米国のサーバーと通信できるようにする方法
- DNS のルートネームサーバーが有名な例。歴史的な経緯により、DNS のルートネームサーバーに設定できる IP アドレスは 13 個に制限されている
  - DNS ルートネームサーバーに要求パケットを送るときは、地域ごとに適したサーバーに IP パケットが送られ、そこから応答が返ってくる
- 便利な仕組みだが、1 つめのパケットと 2 つめのパケットが同じ届く保証がなく、工夫が必要になる場合も

#### 5.8.4 通信品質の制御

- IP はもともとベストエフォートのプロトコルとして設計、開発されているので「通信回線が混雑すると極端に通信性能が低下してしまう」という問題がある
- 通信回線が混雑することをふくそう（輻輳）と呼ぶ
  - 輻輳が発生するとルーターやハブのキューがあふれて大量のパケットが失われ、通信性能が極端に低下する
- 近年は動画や音声、機械制御などのリアルタイム性が要求される通信サービスが普及してきたこともあり、IP を使った通信サービスの品質を保証するための技術が登場した
  - 通信品質の制御として、特定のパケットの優先制御を提供する技術がある
    - IntServ（イントサーブ）や DiffServ（ディフサーブ）など

#### 5.8.6 Mobile IP

- ホスト（スマートフォンやノート PC など）が接続しているサブネットが変わっても IP アドレスが変わらないようにする技術
- ホームアドレスと呼ばれる住民票のようなアドレスや、エージェントを用いることで IP アドレスが変わらないように

## 第 6 章 TCP と UDP

### 6.1 トランスポート層の役割

- TCP は信頼性のある通信を提供し、UDP はマルチキャストやブロードキャストに用いられる
- 必要となる通信の特性により、使用するプロトコルを選択することになる

#### 6.1.1 トランスポート層とは

- IP ヘッダにはプロトコルフィールドとして、どのトランスポートプロトコルにデータを渡すかが番号で定義されている
  - TCP か UDP
- 同様に、トランスポート層である TCP や UDP にも、自分が運んでいるデータを次にどのアプリケーションに渡せばいいかを識別するための番号が定義されている
  - ポート番号

#### 6.1.2 通信の処理

- クライアントサーバー型における、常時起動して特定の処理を行うプロセス（サーバープログラム）の事を UNIX ではデーモンと呼ぶ
- HTTP のサーバープログラムは httpd（HTTP デーモン）、ssh のサーバーは sshd（SSH デーモン）と呼ばれる
- UNIX では個々のデーモンを動かすのではなく、その代表としてクライアントからの要求を待つ、inetd（インターネットデーモン）というスーパーデーモンが使われることがある
  - このスーパーデーモンはサービスの要求を受けると分身（fork）して、sshd などのデーモンに変身（exec）する

#### 6.1.3 2 つのトランスポートプロトコル TCP と UDP

##### TCP

- TCP はコネクション型
- TCP では信頼性を提供するために「順序制御」や「再送制御」を行う
- 「フロー制御（流量制御）」や「輻輳制御」など、数多くの機能を持つ

##### UDP

- UDP はコネクションレス型
- 細かい処理は上位層のアプリケーションが担うことになる

#### 6.1.4 TCP と UDP の使い分け

- UDP は高速性やリアルタイム性を重視する通信、DNS や LAN ないへの通信、IP 電話、テレビ電話などに利用される
- TCP はインターネットを介したビデオオンデマンドや動画再生など、片方向通信の場合に利用される

### 6.2 ポート番号

- TCP／IP による通信では、「宛先 IP アドレス」、「送信元 IP アドレス」、「宛先ポート番号」、「送信元ポート番号」、「プロトコル番号」の 5 つの識別子の組み合わせで通信を区別する

#### 6.2.4 ポート番号の決め方

- 実際に通信を行う場合には、通信の前にポート番号を決定する必要があり、2 種類の方法がある

##### 標準で決められている番号

- ウェルノウンポート番号のこと
- 多くの場合、サーバー側で使われる

##### ダイナミックな割り当て法

- サーバーはポート番号が決まっている必要があるが、クライアント側のポート番号は必ずしも決まっている必要はない
- クライアントアプリケーションは、自分のポート番号を決定せずに、OS に任せることができる
- OS はアプリケーションごとに同じ値にならないように制御しながらポート番号を割り当てる
- この動的なポート番号の割り当てによって、同じクライアントプログラムから複数の TCP コネクションを確立した場合でも、通信を識別する 5 つの識別子が同じにならないようにしている
- 動的に割り当てるポート番号のは 49152 ～ 65535 までの整数が利用される

#### 6.2.5 ポート番号とプロトコル

- ウェルノウンポート番号はトランスポートプロトコルに関係なく、同じ番号が同じアプリケーションに割り当てられている
  - たとえば、53 番のポート番号は TCP でも UDP でも DNS に利用される

### 6.3 TCP（Transmission Control Protocol）

#### 6.4.1 TCP の目的と特徴

- UDP は複雑な制御は行わず、コネクションレスな通信サービスを提供するのに対し、TCP はその名の通り「伝送、送信、通信」を「制御」するプロトコル
- コネクションレス型の IP において、信頼性の高い通信を実現することができる

#### 6.4.2 シーケンス番号と確認応答で信頼性を提供

- TCP では、受信ホストは送信ホストにデータが到達したことを知らせる確認応答（ACK）をする
  - ACK（Positive Acknowledgement）
- データを正常に受信できなかったことを送信側に知らせる否定確認応答（NACK）もある
  - NACK（Negative Acknowledgement）
- TCP では、データを送信したホストはデータの送信後にこの ACK を待つが、これがなければデータの再送を行う
- これらの確認応答処理や再送制御などは、全てシーケンス番号を使って行われる
- 受信側では、受信したデータパケットの TCP ヘッダに書き込まれているシーケンス番号とデータ長を調べ、次に自分が受信すべき番号を確認応答として返送する

#### 6.4.3 再送タイムアウトの決定

- TCP では、パケットを送信するたびにラウンドトリップ時間（往復時間）と、その揺らぎ（分散、ジッタ）を計測する
- その合計より少し大きな値を再送タイムアウト時間としている
- 再送しても確認応答されない場合にはもう一度送信し、確認応答を待つ時間を 2 倍、4 倍へと指数関数的に増やしていく
  - 特定回数の再送で確認応答が無い場合は、ネットワークや相手のホストに異常が発生していると判断し、強制的にコネクションを切断する

#### 6.4.4 コネクション管理

- TCP はコネクション型の通信を提供するので、データ通信に先立って通信を始める準備をしてから通信を行う
- TCP はデータ通信前に TCP ヘッダだけからなるコネクション確立要求のパケット（SYN パケット）を送信して確認応答（ACK）を待つ
  - スリーウェイハンドシェーク
- 通信が終了したときにはコネクションの切断処理を行う（FIN パケット）

#### 6.4.5 TCP はセグメント単位でデータを送信

- TCP ではコネクションの確立時に、1 つの IP パケットで転送する TCP データの最大長を決定する
  - これを最大セグメント長（MSS：Maximum Segment Size）と呼ぶ
  - スリーフェイハンドシェークの確立要求を送る際に、TCP ヘッダに MSS オプションとして NIC で受信可能な MSS を通知する
  - 双方の MSS のうち、小さいほうの値をセグメント単位としてパケットが送信される

#### 6.4.6 ウィンドウ制御で速度向上

- TCP の 1 セグメントごとに確認応答を行った場合、パケットの往復時間（ラウンドトリップ時間）が長くなると通信性能が悪くなる
- そこでウィンドウという概念を取り入れて、複数のセグメントを並列に送信、確認応答する仕組みがある

#### 6.4.7 ウィンドウ制御と再送制御

- 確認応答が失われた場合
  - ウィンドウ制御をしていない場合は再送する必要があった
  - ウィンドウ制御をしていると、ある程度の確認応答が失われても再送する必要がなくなった
- 送信セグメントが失われた場合
  - 確認応答が続くことになる
  - 一度受け取った確認応答と同じものを 3 回連続して受け取った場合に、その確認応答が示しているデータを再送する
  - タイムアウトによる再送制御に比べて高速に動作するため、高速再送制御と呼ばれる

#### 6.4.8 フロー制御（流量制御）

- TCP では送信がは受信側の受信能力に合わせてパケット送信量を制御する
- 受信ホストが送信ホストに受信可能なデータサイズを通知するようになっていて、これがウィンドウサイズとなる
- TCP のヘッダには、ウィンドウサイズを通知するためのフィールドがある
- 受信側のバッファがあふれそうになると、このウィンドウの値を小さく設定し送信ホストに伝えデータ送信量を制御する
- 送信ホストはウィンドウプローブと呼ばれるセグメントを時々送信して、ウィンドウサイズの最新情報を得ている

#### 6.4.9 輻輳制御（ネットワークの混雑解消）

- ネットワークが混雑してパンク状態になることを「ふくそう（輻輳）」という
- TCP ではこれを防ぐため、通信開始時にスロースタートと呼ばれるアルゴリズムに従ってデータ送信量の制御が行われる
- まず、送信側でデータ送信量の「ふくそうウィンドウ」を定義（1 セグメント）
- その後、データパケットの確認応答のたびに、1 セグメントずつ「ふくそうウィンドウ」を大きくしていく
- タイムアウトによる再掃除は「ふくそうウィンドウ」を 1 にしてからスロースタートをやり直す
- 指数関数的にウィンドウが増えてしまうので、閾値が存在

#### 6.4.10 ネットワークの利用効率を高める仕組み

#### 6.4.11 TCP を利用するアプリケーション

### 6.5 その他のトランスポートプロトコル

#### 6.5.1 QUIC（QUIC UDP Internet Connections）

- Google が提案し、IETF によって標準化がすすめられているトランスポートプロトコル
- 現在の Web の多くは TCP 上で HTTP を使って行われているが、QUIC は UDP を利用し、それ自体で暗号通信を可能とする
- 低遅延のコネクション管理や暗号化、高精度な再送処理を行う

#### 6.5.2 SCTP（Stream Control Transmission Protocol）

- TCP と同様にデータの到達性に関する信頼性を提供するトランスポートプロトコル
- SCTP は通信するアプリケーション間で小さなメッセージをたくさん送るときに向いている
- マルチホーミングに対応しており、複数の NIC が付いているホストで、使用できる NIC が変化しても通信を継続できる
- 複数 NIC が供えられているホストで通信の信頼性を高める事ができる

#### 6.5.3 DCCP（Datagram Congestion Control Protocol）

- ふくそう制御の存在しない UDP を補うプロトコルとして登場
- DCCP を利用するアプリケーションの特性により、TCP ライクな輻輳制御と TCP フレンドリーな輻輳制御のどちらかの方法を選択できる

#### 6.5.4 UDP-Lite（Liteweight User Dtagram Protocol）

- UDP の機能を拡張したトランスポートプロトコル
- UDP-Lite は UDP とほぼ同じ機能を提供するが、チェックサムを計算する範囲をアプリケーションが決める事ができる
- UDP の場合はチェックサムエラーが発生するとパケット全体が破棄されるか、チェックサムを無効にする他なかった
- エラーが発生してはいけない部分のみチェックサムで検査するという事が可能に

### 6.6 UDP ヘッダのフォーマット

- UDP ヘッダは「送信元ポート番号」「宛先ポート番号」「パケットの長さ」「チェックサム」から構成される

#### 送信元ポート番号（UDP）

- 16 ビット長のフィールドで、送信元のポート番号を示す
- 送信元ポートは指定しないことも可能で、指定しない場合は「0」とする

#### 宛先ポート番号（UDP）

- 16 ビット長のフィールドで、宛先のポート番号を示す

#### パケット長（UDP）

- UDP ヘッダの長さとデータの長さの和が格納される

#### チェックサム（UDP）

- UDP のヘッダとデータの信頼性を提供するためのもの
-

### 6.7 TCP ヘッダのフォーマット

- TCP ヘッダは UDP と比べてかなり複雑
- 「送信元ポート番号」「宛先ポート番号」「シーケンス番号」「確認応答番号」「データオフセット」「予約」「コントロールフラグ」「ウィンドウサイズ」「チェックサム」「緊急ポインタ」「オプション」「パディング（詰め物）」から構成される

#### 送信元ポート番号

#### 宛先ポート番号

#### シーケンス番号

#### 確認応答番号

#### データオフセット

#### 予約

#### コントロールフラグ

#### ウィンドウサイズ

#### チェックサム

#### 緊急ポインタ

#### オプション

#### パディング

## 第 7 章 ルーティングプロトコル（経路制御プロトコル）

### 7.1 経路制御（ルーティング）とは

- ルーターは経路制御表（ルーティングテーブル）と受け取ったパケットの宛先アドレスを参照して、送信すべき相手先のルーターを決定する
- 経路制御表の作成と管理には、スタティック（静的）ルーティングとダイナミック（動的）ルーティングの 2 種類の方法がある
- スタティックルーティングは固定的に経路情報を設定し、ダイナミックルーティングは自動的に経路情報を設定する（ルーティングプロトコルにより）
- ルーターの数が多い場合には、ダイナミックルーティングの方が管理の手間が少なくなる
- ダイナミックルーティングでは、隣り合うルーター同士がネットワークの接続情報を教えあうことで、経路制御表が完成する（ルーティングアップデート）

### 7.2 経路を制御する範囲

- 経路を制御する範囲によって IGP（Interior Gateway Protocol）と EGP（Exterior Gateway Protocol）という 2 種類のルーティングプロトコルが利用されるようになった
- 経路制御に関するルールを決めて、それをもとに運用する範囲を自律システム（AS：Autonomous System）や経路制御ドメイン（Routing Domain）という
  - 具体例として、地域ネットワークや ISP があげられる
- この自律システム（ルーティングドメイン）の内部でダイナミックルーティングに使われるのが IGP で、自律システム間のルーティングに利用されるのが EGP
- EGP はプロトコルとして BGP(Border Gateway Protocol)が利用されていて、IGP は RIP（Routing Information Protocol）などが利用されている

### 7.3 経路制御アルゴリズム

- 経路アルゴリズムとして代表的なのは「距離ベクトル型」と「リンク状態型」
- 距離ベクトル型は、宛先までの距離と方向（どの隣に送ればいいか）を交換する
  - シンプルだがネットワークが複雑になると経路制御情報が安定するまで時間がかかり、経路にループが生じやすくなるといった問題がある
- リンク状態型は、ルーターがネットワーク全体の接続状態を理解して経路制御表を作成する方法で、各ルーターの情報が同じになれば正しい経路制御が行われることになる
  - ただし、設定や計算が複雑でリソースを多く使う

| プロトコル名 | 下位プロトコル | 方式         | 適応範囲 | ループの検出 |
| ------------ | -------------- | ------------ | -------- | ------------ |
| RIP          | UDP            | 距離ベクトル | 組織内   | ✖            |
| RIP2         | UDP            | 距離ベクトル | 組織内   | ✖            |
| OSPF         | IP             | リンク状態   | 組織内   | ●            |
| EGP          | IP             | 距離ベクトル | 対外接続 | ✖            |
| BGP          | TCP            | 経路ベクトル | 対外接続 | ●            |

### 7.4 RIP

- RIP（リップ、Routing Information Protocol） は距離ベクトル型のルーティングプロトコルで、RIP2 は改良版
  - 最大ホップ数は 15 で、RIP は 30 秒ごとにブロードキャストし、RIP2 の場合はマルチキャストになったなど改良が加わっている
  - 15 ホップ制限があり、大規模ネットワークには不向き
  - （使われているとしたら）現在は RIP2 の方が使われている

### 7.5 OSPF

- OSPF（Open Shortest Path First） はリンク状態型のルーティングプロトコル
  - リンク状態型のルーティングプロトコルは、ネットワークが大きくなるとリンク状態を表すトポロジーデータベースが大きくなり、経路制御情報の計算が大変になる
    - ただ OSPF ではネットワークを複数のエリアに分割することで、不必要なルーティングプロトコルのやり取りを減少させ負荷を軽くできる
    - エリア設計が悪いと OSPF の利点が十分に生かされない場合も

### EIGPR

- EIGRP（Enhanced Interior Gateway Routing Protocol）は、Cisco の独自プロトコル
  - ハイブリッド型と呼ばれ、距離ベクトル型とリンク状態型のどちらも特徴を持つ

### 7.6 BGP

#### 7.6.1 BGP と AS 番号

- BGP は各 ISP 間の接続部分などに利用されている
- BGP と RIP や OSPF が協調的に経路制御を行うことにより、インターネット全体の経路が制御されている
- それぞれの自律システム（AS）には、16 ビットの AS 番号が割り当てられ（現在は 32 ビットに拡張）、BGP ではこの AS 番号を使って経路制御が行われる
- AS の代表者は、AS 内部のネットワークの運営、管理に関する決まりを決定することができる
  - ピアリング（対等な AS 同士が、自分の管理するネットワークと相手の管理するネットワーク間でのみトラフィックを交換する契約）や、トランジット（一方の AS がもう一方の AS からインターネット全体への接続手段を買う契約）など、様々な契約を AS 間で結ぶことになる

#### 7.6.2 BGP は経路ベクトル

- BGP により経路制御情報を交換するルーターを BGP スピーカーという
  - BGP スピーカーは AS 間で BGP の情報を交換するために、情報を交換するすべての AS と対等に BGP のコネクションを確立する
  - 同一 AS に複数の BGP スピーカーがある場合には、AS 内部でも BGP コネクションを確立する
- BGP では、目的とするネットワークアドレスにパケットを送った場合に、そこに到達するまでに通過する AS 番号のリスト（AS Path List）が作られる
  - BGP では各 AS 間の接続契約に基づいたパケット配送を目指すので、基本的には経由する AS の少ないルートを選択するが、契約内容によっては細かい経路選択をする場合もある

#### 個人的補足（Internet Week 2024 資料などより）

- 現在、世界で 7 万以上の AS が接続されているらしい
- 性善説ベースの設定となっている（設定ミスをするとインターネット全体に影響）
  - 経路情報を誤って登録すると、（BGP 的に）近い IP アドレスに通信が到達することがある
  - 経路ハイジャック：パキスタンテレコムの例（<https://www.ripe.net/about-us/news/youtube-hijacking-a-ripe-ncc-ris-case-study/）>
- RPKI（Resource Public Key Infrastructure）の普及が進んでいる
  - BGP には「誰が広告しているか」の本人確認の仕組みがないので、その証明をするための公開鍵基盤です。（この IP/AS はこの組織のもの、という事を証明）

## 第 8 章 アプリケーションプロトコル

### 8.1 アプリケーションプロトコルの概要

- TCP や IP などの下位層のプロトコルはアプリケーションの種類によらず使えるように設計された汎用性の高いプロトコル
- アプリケーションプロトコルは実用的なアプリケーションを実現する為に作られたプロトコル
- 実現しなければならない機能や利用目的によって、一般的もしくは独自のアプリケーションプロトコルを利用することになる

### 8.2 遠隔ログイン（TELNET と SSH）

- Telnet（テルネット） は暗号化されておらず、SSH は通信内容を暗号化する
- Telnet は TCP の 23 番ポートを使用する
- SSH はファイルの転送（scp,sftp）や、ポートフォワード機能が利用できる
  - ポートフォワードとは、特定のポート番号に届けられたメッセージを特定の IP アドレス、ポート番号に転送する仕組み

### 8.3 ファイル転送（FTP）

- インターネット上にはだれでもログインできる FTP サーバが用意されている
  - anonymous（匿名） ftp サーバーと呼ばれる

#### FTP について余談

- 全然関係ないですが興味深いサービスを見つけました（IoT 検索エンジン）
  - [Karma（カルマ）](https://www.00one.jp/karma/)というサービスで、例えば「グローバル IP アドレス × ポート番号」で空いているポートを検索できるようです。
  - [参考記事](https://www.00one.jp/blog/karma/the-anonymous-ftp-server/)

### 8.4 電子メール（E-Mail）

- 初期の電子メールでは、電子メールを送信するホストから受信ホストに直接 TCP のコネクションを確立しメールを配送していた
  - 片方の電源が落ちていると送受信ができなかった
- 電源を切らないメールサーバ―を経由するようになった
  - そして受信者がメールサーバーから電子メールを受け取る POP(Post Office Protocol)というプロトコルが標準化された

#### 8.4.3 MIME（Multipurpose Internet MailExtensions）

- 長い間、インターネットの電子メールはテキスト形式しか扱えなかった
  - しかし現在は電子メールで転送できるデータ形式を拡張する MIME が一般的となった
    - 静止画や動画、音声、プログラムファイルなどさまざまな情報を送ることができる
- MIME は基本的にヘッダと本文（データ）で構成される

#### 8.4.4 SMTP（Simple Mail Transfer Protocol）

- TCP のポート番号は 25 番が利用される
- SMTP は 1 つの TCP コネクションを確立して、そのコネクション上で制御や応答、データからなるメッセージの転送を行う
- クライアントはテキストコマンドで要求を出し、サーバーは 3 桁の数字で表される文字列で応答を返す
- もともとの SMTP には送信者を認証する機能が無い

#### 8.4.5 POP（Post Office Protocol）

- メールは送信者から SMTP によって常時電源が入っている POP サーバーまで到着する
- クライアントは POP によって POP サーバーに保存された相手からのメールを取り出す
  - また、他人にメールを盗み取られる事を防ぐために、ユーザーの認証も行う
- POP でも SMTP と同様に、サーバーとクライアントの間で 1 つの TCP コネクションを利用する
- ローカル PC にメールが保存され、サーバーから削除される

#### 8.4.6 IMAP（Internet Message Access Protocol）

- IMAP は POP と同様に電子メールなどのメッセージを受信するプロトコル
- POP の場合は電子メールの管理をクライアント側で行うが、IMAP の場合はサーバー側で行う
- IMAP を利用することにより、複数の端末から IMAP サーバー上にあるメッセージを読み書きすることができる

### 8.5 WWW（World Wide Web）

- WWW はインターネット上の情報をハイパーテキスト形式で参照できる情報システム
- 文書間のつながりを世界中に蜘蛛の巣のように張り巡らすイメージから、World Wide Web と名付けられた
- WWW では大きく「情報へのアクセス手段と位置の定義、情報の表現フォーマットの定義、情報の転送などの操作の定義」という 3 つの定義が行われている
  - それぞれ URI（Uniform Resource Identifier）、HTML（HyperText Markup Language）、HTTP（HyperText Transfer Protocol）と呼ばれる

#### 8.5.3 URI（Uniform Resource Identifier）

- URI 自体は WWW 以外にも利用できる汎用性の高い識別子
  - ホームページのアドレスや電子メールのアドレス、電話番号など
- URL（Uniform Resource Locator）はインターネットの資源を表す俗称として使われる
  - 現在有効な RFC 文書などでは URL という名称は使われず URI が使われる

#### スキーム

- URI があらわす枠組みをスキーム（scheme）という
- WWW では主に URI スキームのうちの http や https を使って Web ページの位置やアクセス方法を表す
- ftp（File Transfer Protocol）や dav（WebDAV）、mailto（Electronic Mail Address）なども URI スキームに分類される

#### 8.5.4 HTML（HyperText Markup Language）

#### 8.5.5 HTTP（HyperText Transfer Protocol）

- HTTP で定義される認証方式には、Basic 認証と Digest 認証がある
- Basic 認証では base64 でエンコードされるが、ユーザー ID とパスワードは平文でネットワークを流れるので安全ではない
  - HTTPS の暗号化通信と組み合わせて利用することが推奨される
- Digest 認証では、MD5 でハッシュ化をする方式
  - 盗聴されても解析が困難といわれていたが、近年は安全性に懸念がある
- いずれにしても、HTTPS の暗号化通信を使用するのが一般的

※現在はセッション+Cookie（Web アプリ）、トークン認証（API やマイクロサービス）などが主流（書籍外の内容）

- 2015 年 5 月に公開された HTTP/2 は 1 つの接続での並列処理や、バイナリデータの使用による送受信のデータ量の削減、ヘッダ圧縮、サーバープッシュなどの導入により、ネットワークリソースの効率化を実現
  - HTTP/1.1 は 1 リクエスト 1 レスポンスだったが、HTTP/2 は 1 本の TCP コネクション上で複数のリクエストを同時に流せる
  - User-Agent や Cookie など毎回同じヘッダについてヘッダ圧縮（HPACK）をすることで、通信量を削減
  - クライアントがまだ要求していないリソース（CSS や JS）をサーバが先回りして送れる（サーバープッシュ）
- 2016 年 11 月に、TCP のスリーウェイハンドシェークの無い UDP を使う HTTP-over-QUIC が、 インターネットドラフトとして提出されたが、2018 年 12 月に HTTP/3 と名称を新たにした
  - 接続確立が高速（UDP ベース）
  - TLS を標準組み込み（QUIC の設計思想として、TLS1.3 の仕組みが統合済み）

#### 8.5.6 Web アプリケーション

- JavaScript/ CGI / Cookie / WebSocket についての説明

### 8.6 ネットワーク管理（SNMP）

#### 8.6.1 SNMP（Simple Network Management Protocol）

- ネットワーク管理で必要な情報の取得を行うための UDP/IP 上で動作する標準的なプロトコル
- ルーター、スイッチ、サーバーなどの様々なネットワーク機器から情報を収集し、それらを管理することを可能とする

#### 8.6.2 MIB（Management Information Base）

- SNMP でやり取りされる情報が MIB
- ツリー型の構造を持つデータベースで、標準 MIB と各メーカが作成した拡張 MIB が存在する
- SNMP のプレゼンテーション層にあたり、この MIB に値を代入したり取り出すことで、情報の収集や変更、プロトコルの停止や起動などの処理を行える

### 8.7 その他のアプリケーションプロトコル

#### 8.7.1 マルチメディア通信を実現する技術（H.323、SIP、RTP）

- リアルタイムのマルチメディア通信としては、遅延の少なさや即時性の重要視されるので UDP が利用される
  - H.323 や SIP、RIP などが存在
- デジタル圧縮の規格を決める ISO/IEC のワーキンググループとして MPEG（Moving Picture Experts Group）が存在
  - ここで策定された企画が MPEG で、DVD やデジタルテレビ放送に利用されている
  - MP3 も MPEG の規格

#### 8.7.2 P2P（Peer To Peer）

- Skype は P2P の機能を利用している

#### 8.7.3 LDAP（Lighitweight Directory Access Protocol）

- ディレクトリサービスにアクセスするためのプロトコル
- ディレクトリサービスとは、ネットワーク上に存在している様々な資源に関してデータベース的な情報提供を行うサービス
  - LDAP サーバに認証情報を登録しておけば、複数のサーバに同一 ID でログイン可能
- Active Directory などは LDAP を用いたサービス
- LDIF（LDAP Interchange Format）と呼ばれるテキストファイルによって、ツリー構造で情報が管理されている（検索が容易）

#### 8.7.4 NTP（Network Time Protocol）

- ネットワークに接続される機器の時刻を同期するためのアプリケーションプロトコル
  - コンピュータやネットワーク機器のシステム時刻を正確に同期し、分散システムでの一貫性を確保したり、正確なタイムスタンプの記録をサポートする
- NTP はクライアントサーバー型のアプリケーションで、時刻情報を要求するクライアントと提供するサーバーで構成され、UDP ポート 123 番を使う
- Stratum と呼ばれる階層構造を持っていて、最上位の Stratum0 に位置する GPS 衛星や原子時計の正確な時刻情報を下位の NTP サーバーへ配信する仕組みとなっている
  - 国内では、日本標準時を生成している NICT（情報通信研究機構）が Stratum1 の NTP サーバーを運用している（ntp.nict.jp）

## 第 9 章 セキュリティ

### 9.1 セキュリティの重要性

- 特定の組織内の機密情報を狙うサイバー攻撃のことを標的型攻撃という
  - マルウェアが内部ネットワークに侵入後、数か月後に活動を開始して情報を盗み出すなど、持続的に攻撃を行う手法を APT 攻撃という
    - Advanced Persistent Threat（先進的で執拗な脅威）
  - 標的型攻撃には、サイバーキルチェーンと呼ばれるモデルがあり、攻撃を 7 つの段階に分離している
    - それぞれの段階で対応する対策を取り、全体での連携をはかっていくことが重要
- サイバーセキュリティ対策として、SOC（Security Operation Center）や CSIRT（Computer Security Incident Response Team）が増えている
  - 前者はインシデントの検知に重点が置かれていて、後者はインシデント発生後の対応に重点が置かれている

### 9.2 セキュリティの構成要素

#### 9.2.1 ファイアウォール

- ファイアウォールの基本的な考えとして「危険にさらすのは特定のホストやルータ―のみに限定する」というのがある
  - インターネットから直接アクセスできるホストを制限し、そのホストに集中してセキュリティをかける

#### 9.2.2 IDS/IPS（侵入検知システム/侵入防止システム）

- ファイアウォールはポリシーと合致した通信であれば通過させるため、悪意のある通信か判断ができない
- 悪意のある通信や内部に侵入して不正アクセスを行う通信を見つけ、セキュリティ管理者に通知をするのが IDS（侵入検知システム）
  - ファイアウォールや DMZ などに設置されるものもあれば、ネットワーク内部に配置されるものもある
- IPS（侵入防止システム）には、IDS の持つネットワークの監視、異常検知機能に加え、不正侵入を防止する機能がある
  - 不正アクセスを検知した場合に、その不正アクセスを遮断することが可能
- WAF はウェブアプリケーションの脆弱性を悪用する攻撃から守るためのセキュリティ対策なので、レイヤが異なる（アプリケーション層）

#### 9.2.3 アンチウイルス/パーソナルファイアウォール

- IDS/IPS、ファイアウォールに次ぐセキュリティ対策となる
  - ユーザが利用するコンピュータやサーバで動作するソフトウェア
- 潜在的な脅威や生産性の低下の一因になるような要素を取り除く機能も取り込まれていたりする
- クライアントコンピュータのプロセス監視を通じて、潜伏しているマルウェアによる攻撃の兆候や攻撃の進行状況を管理者が把握する事ができる機能も出てきている
- このようなマルウェア防御を備え、アンチウイルスを含む包括的なセキュリティ対策を総称して、エンドポイントセキュリティと呼ぶ
