# マスタリング TCP／IP 入門編

- [マスタリング TCP／IP 入門編](#マスタリング-tcpip-入門編)
  - [第 1 章 ネットワーク基礎知識](#第-1-章-ネットワーク基礎知識)
  - [第 2 章 TCP／IP 基礎知識](#第-2-章-tcpip-基礎知識)
    - [TCP／IP の成り立ち](#tcpip-の成り立ち)
    - [TCP／IP の標準化](#tcpip-の標準化)
    - [インターネットの基礎知識](#インターネットの基礎知識)
    - [TCP／IP の階層の補足](#tcpip-の階層の補足)
  - [第 3 章 データリンク](#第-3-章-データリンク)
    - [3.1 データリンクの役割](#31-データリンクの役割)
    - [3.2 データリンクの技術](#32-データリンクの技術)
      - [3.2.1 MAC アドレス](#321-mac-アドレス)
      - [3.2.2, 3.2.3 媒体共有型と、媒体非共有型のネットワーク](#322-323-媒体共有型と媒体非共有型のネットワーク)
      - [3.2.4 MAC アドレスによる転送](#324-mac-アドレスによる転送)
      - [3.2.6 VLAN](#326-vlan)
    - [3.3 イーサネット（Ethernet）](#33-イーサネットethernet)
      - [3.3.1 イーサネットの接続形態](#331-イーサネットの接続形態)
      - [3.3.2 イーサネットにはいろいろな種類がある](#332-イーサネットにはいろいろな種類がある)
      - [3.3.3 イーサネットの歴史](#333-イーサネットの歴史)
        - [IEEE802](#ieee802)
      - [3.3.4 イーサネットのフレームフォーマット](#334-イーサネットのフレームフォーマット)
    - [3.4 無線通信](#34-無線通信)
      - [3.4.1 無線通信の種類](#341-無線通信の種類)
      - [3.4.2 IEEE802.11](#342-ieee80211)
        - [CSMA/CA](#csmaca)
      - [3.4.3 IEEE802.11b、IEEE802.11g](#343-ieee80211bieee80211g)
      - [3.4.4 IEEE802.11a](#344-ieee80211a)
      - [※IEEE802.11n,IEEE802.11ac は省略](#ieee80211nieee80211ac-は省略)
      - [3.4.7 IEEE802.11ax（Wi-Fi 6）](#347-ieee80211axwi-fi-6)
      - [3.4.8 無線 LAN を使用する場合の留意点](#348-無線-lan-を使用する場合の留意点)
      - [3.4.9 WiMAX](#349-wimax)
      - [3.4.10 Bluetooth](#3410-bluetooth)
      - [※ZigBee、LPWA は省略](#zigbeelpwa-は省略)
    - [3.5 PPP（Point-to-Point Protocol）](#35-ppppoint-to-point-protocol)
      - [3.5.1 PPP とは](#351-ppp-とは)
      - [LCP と NCP、PPP のフレームフォーマット、PPPeE は省略](#lcp-と-ncpppp-のフレームフォーマットpppee-は省略)
    - [3.6 その他データリンク](#36-その他データリンク)
      - [※ATM、POS、ファイバーチャネル、iSCSI、InfiniBand、IEEE1394、DOCSIS、高速 PLC は省略](#atmposファイバーチャネルiscsiinfinibandieee1394docsis高速-plc-は省略)
      - [3.6.7 HDMI](#367-hdmi)
    - [3.7 公衆アクセス網](#37-公衆アクセス網)
      - [3.7.1 アナログ電話回線](#371-アナログ電話回線)
      - [3.7.2 モバイル通信サービス](#372-モバイル通信サービス)
      - [※ADSL と FTTH は省略](#adsl-と-ftth-は省略)
      - [3.7.5 ケーブルテレビ](#375-ケーブルテレビ)
      - [3.7.6 専用回線（専用線）](#376-専用回線専用線)
      - [3.7.7 VPN（Virtual Private Network）](#377-vpnvirtual-private-network)
        - [IP-VAN](#ip-van)
        - [広域イーサネット](#広域イーサネット)
      - [3.7.8 公衆無線 LAN](#378-公衆無線-lan)
      - [※その他の公衆通信サービスは省略](#その他の公衆通信サービスは省略)
  - [第 4 章 IP](#第-4-章-ip)
    - [4.1 IP はインターネット層のプロトコル](#41-ip-はインターネット層のプロトコル)
      - [4.1.1 IP は OSI 参照モデルの第 3 層に相当](#411-ip-は-osi-参照モデルの第-3-層に相当)
      - [4.1.2 ネットワーク層とデータリンク層の関係](#412-ネットワーク層とデータリンク層の関係)
    - [4.2 IP の基礎知識](#42-ip-の基礎知識)
      - [4.2.1 IP アドレスはネットワーク層のアドレス](#421-ip-アドレスはネットワーク層のアドレス)
      - [4.2.2 経路制御（ルーティング）](#422-経路制御ルーティング)
      - [4.2.3 データリンクの抽象化](#423-データリンクの抽象化)
      - [4.2.4 IP はコネクションレス型](#424-ip-はコネクションレス型)
    - [4.3 IP アドレスの基礎知識](#43-ip-アドレスの基礎知識)
      - [4.3.4 ブロードキャストアドレス](#434-ブロードキャストアドレス)
        - [2 つのブロードキャスト](#2-つのブロードキャスト)
      - [4.3.5 IP マルチキャスト](#435-ip-マルチキャスト)
      - [4.3.8 グローバルアドレスとプライベートアドレス](#438-グローバルアドレスとプライベートアドレス)
      - [4.3.9 グローバル IP アドレスは誰が決める](#439-グローバル-ip-アドレスは誰が決める)
    - [4.4 経路制御（ルーティング）](#44-経路制御ルーティング)
      - [4.4.1 IP アドレスと経路制御（ルーティング）](#441-ip-アドレスと経路制御ルーティング)
      - [4.4.2 経路制御表の集約](#442-経路制御表の集約)
    - [4.5 IP の分割処理と再構築処理](#45-ip-の分割処理と再構築処理)
      - [4.5.1 データリンクによって MTU は異なる](#451-データリンクによって-mtu-は異なる)
      - [4.5.2 IP データグラムの分割処理と再構築処理](#452-ip-データグラムの分割処理と再構築処理)
      - [4.5.3 経路 MTU 探索（Path MTU Discovery）](#453-経路-mtu-探索path-mtu-discovery)
    - [4.6 IPv6（IP version 6）](#46-ipv6ip-version-6)
    - [4.7 IPv4 ヘッダ](#47-ipv4-ヘッダ)
    - [4.8 IPv6 のヘッダフォーマット](#48-ipv6-のヘッダフォーマット)
  - [第 5 章 IP に関連する技術](#第-5-章-ip-に関連する技術)
    - [5.2 DNS（Domain Name System）](#52-dnsdomain-name-system)
      - [5.2.1 IP アドレスを覚えるのはたいへん](#521-ip-アドレスを覚えるのはたいへん)
      - [5.2.3 ドメイン名の構造](#523-ドメイン名の構造)
        - [ネームサーバー](#ネームサーバー)
    - [5.3 ARP（Address Resolution Protocol）](#53-arpaddress-resolution-protocol)
    - [5.4 ICMP（Internet Control Message Protocol）](#54-icmpinternet-control-message-protocol)
    - [5.5 DHCP（Dynamic Host Configuration Protocol）](#55-dhcpdynamic-host-configuration-protocol)
    - [5.6 NAT（Network Address Translator）](#56-natnetwork-address-translator)
      - [5.6.4 CGN（Carrier Grade NAT）](#564-cgncarrier-grade-nat)
    - [5.7 IP トンネリング](#57-ip-トンネリング)

## 第 1 章 ネットワーク基礎知識

- ISO（国際標準化機構）が OSI 参照モデルを定めた
- TCP／IP は IETF（インターネット技術の標準化を推進する任意団体）で標準化がすすめられているプロトコル
- SNS で文書を送る例を基に、OSI 参照モデルの各層を解説
  - アプリケーション層・・・メッセージ、宛先の情報
  - プレゼンテーション層・・・ネットワーク全体で統一された表現形式 ⇔ コンピュータやソフトウェアに適した表現形式の変換をする
    - 符号化形式・・・UTF-8、Shift_JIS など
  - セッション層・・・どんなコネクションを使って転送するか、データ転送自体の機能は持たない
  - トランスポート層・・・コネクションの確立や切断
  - ネットワーク層・・・ネットワーク間の接続がある環境で、ホスト間のデータの受け渡しを行う。IP アドレスが必要
  - データリンク、物理層・・・MAC アドレスが指定。物理マシンの一区間ごとにパケットのヘッダとして付与
- 通信方式の種類
  - コネクション型とコネクションレス型・・・コネクションレス型はコネクションを確立せずに送信
  - 回線交換とパケット交換・・・パケット交換ではパケット交換機（ルーター）によって通信回線が結ばれる
    - ルーターの中にはバッファと呼ばれる記憶領域があり、パケットは一旦ここに格納されるが、大量のパケットが流れると溢れてパケットロスになる
- IP アドレスと MAC アドレス
- IP アドレスは階層性があるが、MAC アドレスには階層性が無い
- ネットワークの途中にある通過点では、各パケットのアドレスを見てどのネットワークインターフェースから送り出すかを決める
  - その為にアドレスごとに送出インターフェースを記したテーブルを参照する
  - MAC アドレスの場合は転送表（フォワーディングテーブル）と言い、IP アドレスの場合は経路制御表（ルーティングテーブル）

## 第 2 章 TCP／IP 基礎知識

### TCP／IP の成り立ち

- 1960 年代に、大学や各研究所で新しい通信技術の研究が行われるように
- 1960 年代後半には、パケット交換技術・パケット通信に注目するように
  - 分散型のネットワークであれば、攻撃を受けても迂回路がある限り通信を継続できる
  - また、パケット通信を利用する事で、複数のユーザーで同時に一つの回線を共有する事ができ、回線の利用効率が向上する
- 1969 年に、ARPANET（アーパネット）と呼ばれるネットワークが構築された
  - パケット通信の実用性の試験がされ、ARPANET はインターネットの起源とされている
- 1975 年に、ARPANET 内の研究グループによって TCP／IP が誕生
- 1980 年代は大学や研究所などで LAN が発達するとともに UNIX の普及が急速に進み、同時に TCP／IP によるネッワーク構築が盛んにおこなわれるように
  - TCP／IP による世界的なネットワークを「インターネット」と呼ぶようになったのはこの頃から
- 1990 年代は企業や一般家庭に対して、ISP（インターネットサービスプロバイダ）がインターネットへの接続を提供するように

### TCP／IP の標準化

- 多くの場合、TPC／IP は TCP と IP だけでなく、プロトコル群の総称として使われる
- 標準化については、他の標準化と比べると２つの点が大きく異なる
  - オープンであり、IEFE での議論を通して決められる
  - 実際に使えるプロトコルであるかが重視される
- 標準化しようとするプロトコルは RFC（Request For Comments）として番号が割り振られ、ドキュメントとして IETF の ftp および web サーバを通じて閲覧可能となる

※全然関係ないが、ひたすら Qiita に joke-rfc を纏めている方を発見した
<https://qiita.com/yoshi389111>

### インターネットの基礎知識

- 現在、インターネットというと ARPANET（アーパネット）から発展し、全世界を接続しているコンピュータネッ- ワークを指す
- インターネットと TCP／IP の関係として、インターネットのプロトコルと言えば TCP／IP という事になる
- ISP や地域ネットワークに属する形で、組織や家庭のネットワークが存在している
- ネットワーク同士は NOC（Network Operation Center）で接続される
- ネットワーク運用者や運用方針が異なるネットワークを対等に接続するポイントは IX（Internet Exchange）と- ばれる
- NOC とは、ISP 等が地域ごとに設ける集中的な運用拠点を指す事が多い
- <https://e-words.jp/w/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%BB%E3%83%B3%E3%82%BF%E3%83%BC.html>

### TCP／IP の階層の補足

- ネットワーク層（インターネット層）
  - インターネットは、インターネット層の機能を備えたネットワーク（要はデータリンク層、物理層は抽象化される）
  - インターネットに接続される全てのホストやルーターは必ず IP の機能を実装しなければならない
- トランスポート層
  - アプリケーションプログラム間の通信を実現する
- アプリケーション層
  - アプリケーションプログラムの中で実現される
- パケットの送信例
  - 各階層では送信されるデータにヘッダと呼ばれる情報が付加される
  - イーサネットヘッダ、IP ヘッダ、TCP ヘッダ
  - それぞれのヘッダには少なくとも「宛先と送信元のアドレス」と「上位層のプロトコルが何かを示す情報」が入っている

## 第 3 章 データリンク

### 3.1 データリンクの役割

- TCP／IP では、データリンク層と物理層が透過的に機能している事を前提にしている
- データリンクとは、直接的に接続されているコンピュータ間の通信を可能にするプロトコル
- この章では、MAC アドレス、スイッチング技術、ループ検出、VLAN、無線 LAN、PPP 等について紹介する
- データリンクのセグメントについて
  - 区切られた 1 つのネットワークという意味でセグメントが使われる
  - 例えばリピーターを介して 2 つのケーブルを接続している例だと、物理層の観点から見ると 1 つのケーブルで 1 セグメントだが、ネットワーク層の観点から見ると、1 セグメントと見なされる

### 3.2 データリンクの技術

#### 3.2.1 MAC アドレス

- MAC アドレスはイーサネットや無線 LAN、Bluetooth でも使われる
  - 48 ビット長で、ベンダ識別子とベンダ内の識別子で構成され世界中で唯一となる
  - ただし、同じデータリンク内に同一の MAC アドレスが存在しなければいいという話なので、絶対に唯一の値とは限らない
  - ベンダ識別子は IEEE が割り当てる
    - 00-00-0E は富士通、という形で割り当てられている
    - [MAC ベンダー検索くん](http://mobile.shinsv.mydns.jp/tech/mac_address/cm.html)

#### 3.2.2, 3.2.3 媒体共有型と、媒体非共有型のネットワーク

- 媒体共有型
  - 通信媒体を複数のノードで共有する
  - 基本的には半二重通信となり、通信の優先権を制御する仕組みが必要
- 媒体非共有型
  - 通信媒体を共有せずに占有する方式
  - スイッチに接続し、スイッチがフレームを転送する
  - 全二重通信が可能で、送受信を同時に行える

#### 3.2.4 MAC アドレスによる転送

- 媒体非共有型で利用されていたスイッチ技術をイーサネットで利用できるようにしたのがスイッチングハブやイーサネットスイッチ
- スイッチの送出インターフェース（ポート）と MAC アドレスを記したテーブルを転送表といい、スイッチで自動的に生成される
  - どのホストがどのインターフェースに接続されているかは、パケットの送受信で判明し、転送表に書き込む
  - これをスイッチでの自己学習という
- MAC アドレスに階層性はないので、転送表のエントリにはそのデータリンク内に存在する機器の数だけ必要
  - 転送表の検索にかかる時間も長くなるので、たくさんの端末をつなげる場合は複数のデータリンクに分ける

#### 3.2.6 VLAN

- スイッチのポートごとにセグメントを分ける事で、ブロードキャストのトラフィックが流れる範囲を区切れる
- 異なるセグメント間で通信を行うには、ルーターの機能を備えたスイッチ（L3）を利用するか、セグメント間をルーターで結ぶ必要がある

### 3.3 イーサネット（Ethernet）

- データリンクで現在最も普及しているのがイーサネット
- 制御の仕組みが単純で、ほかのデータリンクよりも NIC やデバイスドライバが作りやすく、低価格で利用できたことがイーサネット普及の大きな要因でもある

#### 3.3.1 イーサネットの接続形態

- イーサネット普及当初は同軸ケーブルを利用する媒体共有型の接続が一般的
- 現在では、端末とスイッチの間を占有のケーブルで接続する形に

#### 3.3.2 イーサネットにはいろいろな種類がある

- 10BASE,100BASE,1000BASE,10GBASE とあるが、それぞれ 10Mbps,100Mbps,1Gbps,10Gbps といった伝送速度を意味している
- 後ろに 5,2,T,F などの文字が入るが、これは媒体の違いを意味している

#### 3.3.3 イーサネットの歴史

- イーサネットは同軸ケーブルを使う 10BASE5 が最初に規格化された
- 歴史的には多様なイーサネットがあるが、いずれも IEEE802.3 分科会で標準化されている

##### IEEE802

- IEEE（The Institute of Electrical and Electronics Engineers：米国電気電子技術者協会）委員会では、様々な LAN 技術の標準化を進めている
- 802 という数字は 1980 年 2 月に Lan の標準化のプロジェクトが始まったことに由来している

#### 3.3.4 イーサネットのフレームフォーマット

- イーサネットフレームの先頭には 1 と 0 を交互に並べたプリアンプルと呼ばれるフィールドが付けられる
- フレームの中には MAC アドレス、データ、FCS（フレームが壊れていないかチェックする為のフィールド）がある

### 3.4 無線通信

- 電波や赤外線、レーザー光線などを利用する
- 無線通信の中でオフィス内のような LAN の範囲を比較的高速で接続する物を無線 LAN と呼ぶ

#### 3.4.1 無線通信の種類

- 通信距離に応じて、分類が出来る
- IEEE802 委員会で、PAN~RAN の規格化が進められている

| 短距離無線 | 規格化団体             | 技術名称        |
| ---------- | ---------------------- | --------------- |
| 短距離無線 | 個別                   | RF-ID           |
| 無線 PAN   | IEEE802.15             | Bluetooth       |
| 無線 LAN   | IEEE802.11             | Wi-Fi           |
| 無線 MAN   | IEEE802.16, IEEE802.20 | WiMAX           |
| 無線 RAN   | IEEE802.22             | ---             |
| 無線 WAN   | 3GPP                   | 3G, LTE, 4G, 5G |

#### 3.4.2 IEEE802.11

- 多くの規格の総称として用いられる場合と、無線 LAN の一通信方式として用いられる場合がある
- 一通信方式の IEEE802.11 としては、物理層で電波もしくは赤外線を用いて、1Mbps もしくは 2Mbps の通信速度を実現する規格（後発の規格に劣る為、ほとんど利用されていない）

##### CSMA/CA

- 無線 LAN が利用する電波は有限なので、媒体共有型のネットワーク
- イーサネットで採用されている CSMA/CD と似た CSMA/CA というアクセス制御方式を採用している
  - データを送信してよい状態か確認し、ランダムな時間待ってからデータ送信を開始する事で衝突を回避

#### 3.4.3 IEEE802.11b、IEEE802.11g

- 2.4GHz 帯の電波を利用
- 最大 11Mbps および 54Mbps

#### 3.4.4 IEEE802.11a

- 5GHz 帯の電波を利用
- 最大 54Mbps

#### ※IEEE802.11n,IEEE802.11ac は省略

#### 3.4.7 IEEE802.11ax（Wi-Fi 6）

- 2.4GHz または 5GHz 帯を利用
- 最大 9.6Gbps の伝送速度を実現

#### 3.4.8 無線 LAN を使用する場合の留意点

- 2018 年に WPA3（鍵長 128/192bit）が登場したが、それまでは WPA2（AES ベース、鍵長 128bit）
- 電子レンジを動作させると 2.4GHz 帯の転送能力が著しく低下する場合

#### 3.4.9 WiMAX

- Worldwide Interoperability for Microwave Access の略
- マイクロ波を使って企業や自宅への無線接続を行う方式
- 無線 MAN に属し、大都市圏をエリアとする広範囲なワイヤレスネットワークをサポートする

#### 3.4.10 Bluetooth

- IEEE802.11b/g などと同じ 2.4GHz 帯を使って通信する
- Bluetooth4.0 では低消費電力を実現する Bluetooth Low Energy が策定され、IoT デバイスなどで活用されている

#### ※ZigBee、LPWA は省略

### 3.5 PPP（Point-to-Point Protocol）

#### 3.5.1 PPP とは

- 1 対 1 でコンピュータを接続するためのプロトコル
- イーサネットや FDDi はデータリンク層、物理層に関係していたが、PPP は純粋なデータリンクのプロトコル
- 電話回線や ISDN、専用線などで利用されている
- ADSL やケーブルテレビなどを使ったインターネット接続で PPPoE（PPP over Ethernet）として利用されるように
  - 家庭内 LAN やルータなどの機器と、ISP 内に設置された通信機器の間で接続を確立する手段として利用される

> [!NOTE]
> 近年ではイーサネットを前提とした IPoE が登場し、ネットワーク終端装置を必要とせずにインターネットに接続できる場合も

#### LCP と NCP、PPP のフレームフォーマット、PPPeE は省略

### 3.6 その他データリンク

#### ※ATM、POS、ファイバーチャネル、iSCSI、InfiniBand、IEEE1394、DOCSIS、高速 PLC は省略

#### 3.6.7 HDMI

- 2009 年に公開されたバージョン 1.4 からイーサネットのフレームを伝送する企画が追加
- HDMI ケーブルを使って TCP/IP による通信が可能に

### 3.7 公衆アクセス網

- LAN などのような構内の接続ではなく、外部と接続する場合に使用する公衆通信サービスについて解説
- 公衆通信サービスとは、NTT や KDDI、ソフトバンクなどの通信事業者に料金を払って通信回線を借りる形態

#### 3.7.1 アナログ電話回線

- いわゆる固定電話回線を利用して通信を行う
- 特別な通信回線を必要とせず、一般家庭に広く普及している電話網をそのまま利用できる
- 現在はほとんど利用されていない

#### 3.7.2 モバイル通信サービス

- 1G,2G,PHS,3G,4G-LTE と規格化が進んでいる
- 5G は上り 480Mbps、下り最大 10〜20Gbps ほど

#### ※ADSL と FTTH は省略

#### 3.7.5 ケーブルテレビ

- 電波を使うテレビ放送をケーブルを使って放送
- ケーブルテレビを使ったインターネット接続サービスが広く行われるように
  - 放送に使われていない空いているチャンネルをデータ通信専用に利用
- インターネットへの接続は加入者宅からケーブルモデムで信号変換され、ケーブルテレビ網を通り ISP に接続される

#### 3.7.6 専用回線（専用線）

- イーサネット専用線サービスなど

#### 3.7.7 VPN（Virtual Private Network）

- VPN サービスには IP-VPN、広域イーサネットがある

##### IP-VAN

- IP ネットワークに VPN を構築する
- MPLS(Multiprotocol Label Switching)技術を用いて、パケットへのラベル付けにより通信事業者のネットワーク内に仮想的な独自ネットワークを作り上げる
- IP-VPN サービス以外にも、企業が独自にインターネット上に VPN を構築する場合もある、IPsec により実現する方法が一般的になっている（IPsec については九章で解説）

##### 広域イーサネット

- IP-VPN が IP 層での接続サービスであるのに対して、広域イーサネットはデータリンク層であるイーサネットを用いた VLAN（バーチャル LAN）を利用する
- イーサネットをそのまま利用するので、TCP/IP 以外のプロトコルも利用できる
- 広域イーサネットは通信事業者が構築する VLAN を、利用企業が専用で利用する形になるので、不要なパケットを流さないように利用者が工夫した上で運用する事が必要に

#### 3.7.8 公衆無線 LAN

- Wi-Fi（IEEE802.11b など）を利用したサービス

#### ※その他の公衆通信サービスは省略

## 第 4 章 IP

- この章では IP について説明

### 4.1 IP はインターネット層のプロトコル

#### 4.1.1 IP は OSI 参照モデルの第 3 層に相当

- IP は OSI 参照モデルの第 3 層のネットワークに相当する
- ネットワーク層の役割は「終点ノード間の通信を実現する」こと
- データリンクを超えた通信をする為にはネットワーク層が必要

#### 4.1.2 ネットワーク層とデータリンク層の関係

- データリンク層は 1 区間の通信を実現するのに対して、ネットワーク層は最終目的地までの通信を実現する
- 旅行で言う所の、切符や航空券がデータリンク層で、旅行の行程表がネットワーク層

### 4.2 IP の基礎知識

#### 4.2.1 IP アドレスはネットワーク層のアドレス

- IP アドレスの形式は、ホストがどのような種類のデータリンクに接続されていても、全く同じものが使われる
- イーサネットも、無線 LAN も、PPP でも、IP アドレスの形式は同じ
- ネットワーク層には、データリンク層の性質を抽象化する役割がある
- TCP/IP で通信するすべてのホストやルーターには、必ず IP アドレスを設定する必要がある
  - ブリッジやスイッチングハブなど、物理層やデータリンク層でパケットを中継する機器には設定する必要はない

#### 4.2.2 経路制御（ルーティング）

- 経路制御とは、宛先 IP アドレスのホストまでパケットを届けるための仕組み
- TCP/IP では、ネットワークの 1 区間を IP パケットが跳ぶことをホップという
  - ここでの 1 ホップは送信元 MAC アドレスから宛先 MAC アドレスのでフレームが転送される区間を指す
  - それぞれの区間（ホップ）ごとに個々のルーターが IP パケットの転送処理を行い、最終的な宛先ホストにパケットがたどり着く
- すべてのホストやルーターは経路制御表（ルーティングテーブル）を持っている

#### 4.2.3 データリンクの抽象化

- IP は複数のデータリンクで接続されたネットワーク間の通信を実現する
- IP から見て、データリンク間で異なるのは最大転送速度（MTU：Maximum Transmission Unit）
  - ただ、IP より上位層でこの MTU よりも大きなパケット長の送信要求がくるかもしれず、この問題に対処するために IP では分割処理（フラグメンテーション）を行い、IP パケットを分割する

#### 4.2.4 IP はコネクションレス型

- コネクションレス型なので、パケットを送信する前に通信相手との間にコネクションの確立を行わない
  - これは機能の簡略化と高速化の為であり、パケットの取りこぼしなど無駄な通信をする可能性もある
  - 信頼性を高めるのは上位層の TCP の役目で、こちらはコネクション型となる
- IP は最善努力型（ベストエフォート）のサービスと呼ばれる

### 4.3 IP アドレスの基礎知識

- IP パケットが途中のルーターで転送されるときには、宛先 IP アドレスのネットワーク部が利用される
- ネットワーク部は同一セグメント内では同じ値にし、ホスト部は同一セグメント内で違う値とする

#### 4.3.4 ブロードキャストアドレス

- 各ネットワーク（サブネット）の最後のアドレス（ホスト部の全ビットが「1」）をブロードキャストアドレスと呼ぶ
- 172.20.0.0/16 の場合は、172.20.255.255 がブロードキャストアドレス
- ブロードキャストを必要としないホストは、IP より上位の層でパケットを廃棄する

##### 2 つのブロードキャスト

- ローカルブロードキャストとダイレクトブロードキャストがある
- ローカルブロードキャストは、自分が属しているリンク内ブロードキャストの事
- ダイレクトブロードキャストは、異なる IP ネットワークのブロードキャストアドレスにブロードキャストする事
  - ただしセキュリティ上の問題がある為、ルーターで転送されないように設定されている場合が多い

#### 4.3.5 IP マルチキャスト

- 特定のグループに所属するすべてのホストにパケットを送信する為に利用される
- 範囲は 224.0.0.0/4（224.0.0.0 から 224.255.255.255 まで）

#### 4.3.8 グローバルアドレスとプライベートアドレス

- プライベートアドレスは次の範囲
  - `10. 0.  0.  0` 　～　 `10. 255. 255. 255`
  - `172. 16. 0. 0` 　～　 `172. 31. 255. 255`
  - `192. 168. 0. 0` 　～　 `192. 168. 255. 255`
- この範囲外の IP アドレスはグローバル IP アドレスと呼ばれる

#### 4.3.9 グローバル IP アドレスは誰が決める

- ICANN（Internet Corporation for Assigned Names and Numbers）で一元管理されている
- 日本では JPNIC（Japan Network Information Center）がグローバル IP アドレスの割り当て機関として活動している
- 現在はユーザーが ISP にインターネットの接続を依頼するとき、ISP がユーザーに代わって JPNIC にアドレス割り当てを申請する事になる

### 4.4 経路制御（ルーティング）

- IP において、ホストやルーターは経路制御表（ルーティングテーブル）をもとにパケットの送信先を決定する
- 管理者が事前に設定する方法をスタティックルーティング（静的経路制御）、ルーターが他のルーターと情報を交換して自動的に作成する方法をダイナミックルーティング（動的経路制御）と呼ぶ

#### 4.4.1 IP アドレスと経路制御（ルーティング）

- 経路制御表には、ネットワークアドレスと次に配送すべきルーターのアドレスが書かれている
- デフォルトルート
  - 経路制御表のどのアドレスにもマッチしない場合はデフォルトルートへ流れる
  - デフォルトルートは 0.0.0.0/0、または default と記述する
- ホストルート
  - IP アドレス/32（ex 192.168.153.15/32）はホストルートと呼ばれる
  - このホストルートを利用すると、IP アドレスのネットワーク部ではなくネットワークインターフェースにつけた IP アドレスそのものに基づいて経路制御が行われる
- ループバックアドレス
  - 同一コンピュータ内で通信したい場合に利用される
  - 127.0.0.1 という IP アドレス、または localhost というホスト名が利用される
  - このアドレスを利用した場合、パケットはネットワークには流れない
- リンクローカルアドレス
  - ルーターを超えない同一リンク内での通信に利用される
  - 169.254/16 という IP アドレス
  - 固定 IP が設定されていないホストで、DHCP による IP アドレスの取得が出来なかった時に設定される事がある

#### 4.4.2 経路制御表の集約

- 経路制御表が大きくなると、その管理にメモリ空間や CPU が必要になる他、検索に時間がかかり IP パケットの転送能力が低下する
- 大規模なネットワークを構築する場合は、経路制御表をいかにして小さく保つかが課題の一つとなる

### 4.5 IP の分割処理と再構築処理

#### 4.5.1 データリンクによって MTU は異なる

- MTU（最大転送単位）はデータリンクによって異なる
- IP はデータリンクの上位層として、MTU に左右されることなく利用できなければならない

#### 4.5.2 IP データグラムの分割処理と再構築処理

- IP ヘッダには分割された断片の位置とそのパケットの後に断片が続いている事を示すフラグがある
  - このフラグで、IP データグラムが分割されている事と、断片の始まりか、中間か、終わりかが分かる
- 分割された IP データグラムを元の IP データグラムに戻す処理は終点の宛先ホストだけで行われる
  - 途中でデータを失ったり、再び分割が必要になる可能性を考慮し、終点で再構築処理を行うようになっている

#### 4.5.3 経路 MTU 探索（Path MTU Discovery）

- 経路 MTU とは、送信先ホストから宛先ホストまで分割処理が必要にならない最大の MTU の事
  - つまり、経路に存在するデータリンクの最小の MTU
- 経路 MTU 探索とは
  - 分割処理はルーターの負荷がかかり、データが失われるリスクも上がる事から、経路 MTU を発見し送信元ホストで経路 MTU の大きさにデータを分割して送信する方法
  - 最近の多くの OS で実装されるようになった

### 4.6 IPv6（IP version 6）

### 4.7 IPv4 ヘッダ

### 4.8 IPv6 のヘッダフォーマット

## 第 5 章 IP に関連する技術

この章では IP を支える様々な関連技術について説明します（DNS、ARP、ICMP、DHCP、NAT）

### 5.2 DNS（Domain Name System）

#### 5.2.1 IP アドレスを覚えるのはたいへん

- ARPANET では、当初は hosts ファイルをネットワークインフォメーションセンター（SRI-NIC）で一括管理していた

#### 5.2.3 ドメイン名の構造

- ドメイン名は長い間 ASCII 文字しか使えなかったが、現在では日本語など多国語に対応している
  - 追加で調べた事：DNS は日本語に対応していないので、日本語は一度「ピュニコード（Punycode）」に変換される

##### ネームサーバー

- ドメイン名を管理しているホストやソフトウェアの事
- ネームサーバーは、そのネームサーバーが設置された階層のドメインに関する情報を管理する
  - それぞれのネームサーバーは下の階層のネームサーバーの IP を知っており、ルートからネームサーバーが木構造の様に結ばれている

### 5.3 ARP（Address Resolution Protocol）

- アドレス解決のためのプロトコル
- 宛先ホストが同一リンク上にない場合に、次ホップのルーターの MAC アドレスを ARP で調べる事になる
  - IPv6 では ARP の代わりに ICMPv6 の近隣探索メッセージが利用される
- ARP 要求パケットと応答パケット
  - 宛先の IP は分かるが、MAC アドレスが分からない場合、ARP 要求パケットをブロードキャストする
  - ARP 要求パケットにより、宛先の IP に対応する MAC アドレスを埋めて返すのが ARP 応答パケット
- 通常 ARP により取得した MAC アドレスは数分間キャッシュされる
- IP アドレスと MAC アドレスの対応関係を記憶するデータベースを ARP テーブルと呼び、`arp -a`で内容を表示できる
- IP アドレスと MAC アドレスの両方が分からないと、パケットの配送はできない
  - MAC アドレスだけだと、別リンクのホストに配送できない
  - IP アドレスだけだと、経由先のルーターを示す情報が無い

### 5.4 ICMP（Internet Control Message Protocol）

- IP パケットが目的のホストまで届くかどうかを確認する機能など、トラブルシューティングに役立つのが ICMP
- ICMP による情報の通知は IP を使って配送される
- ICMP には、大きく分類すると「エラー通知の為のエラーメッセージ」と「診断などを行う問い合せメッセージ」の 2 種類がある
- IP パケットの TTL による破棄が行われた場合、IP ルーターは ICMP 時間超過メッセージのコード 0 を送信元に送り返し、パケットが破棄されたことを通知する
  - この仕組みを利用したのが`traceroute`（`tracert`）で、宛先ホストに到達するまでに、どのようなルーターを通過するかを表示してくれる
- IPv4 においては、ICMP は補助的な役割だが、IPv6 においては ICMP の役割が大きくなる
  - IP アドレスから MAC アドレスを調べるプロトコルが ARP から ICMP の近隣探索メッセージに変更される

### 5.5 DHCP（Dynamic Host Configuration Protocol）

- 個々の端末（DHCP クライアント）に対する IP アドレスの設定の自動化や、配布する IP アドレスの一括管理を行うために DHCP が利用される
- DHCP サーバーがある事で、ネットワークに接続すると TCP/IP の通信に必要な設定が行われる
  - そのセグメントのルーターが DHCP サーバーになることも多い
- DHCP で IP アドレスを取得する際は、IP アドレスの設定要求後、IP アドレスの設定使用の要求の 2 段階に分かれる
  - これは、DHCP サーバーを 2 つ以上設置しても正しく動作するようにするため
  - DHCP サーバーに障害が発生すると IP アドレスが配られなくなるため、複数の DHCP サーバーを起動する事が奨励されている
- DHCP リレーエージェントを使う事で、複数の異なるセグメントの IP アドレスの割り当てを一つの DHCP サーバーで管理・運用できます。

### 5.6 NAT（Network Address Translator）

- 現在は単に NAT といっても NAPT の事を指すのが普通
- モバイルルーターやスマートフォンのテザリング（インターネット共有）も、NAPT によるもの
- TCP や UDP を利用した通信の場合、「宛先 IP アドレス」「送信元 IP アドレス」「宛先ポート番号」「送信元ポート番号」「TCP による通信か UDP による通信かを表すプロトコル番号」の 5 つの識別子が同じでなければ同一の通信とはみなされない
  - これを利用したのが NAPT
- NAT（NAPT）対応ルーターの内部では、送信元 IP アドレスとグローバル IP アドレスを変換する為の変換テーブルが自動的に作成される

#### 5.6.4 CGN（Carrier Grade NAT）

- LSN（Large Scale NAT）とも呼ばれる
- ISP レベルで NAT を行う技術で、2 段階の NAT となっている
  - 1 段目（ISP の CGN）
    - ISP が各組織に配布したプライベート IP アドレス とグローバル IP アドレスの変換
  - 2 段目（各組織の NAT）
    - 各組織のプライベート IP アドレスと ISP が各組織に配布したプライベート IP アドレス

:::note info
CGN はポート番号の枯渇問題がある  
AWS だと、マルチキャストやブロードキャストが出来ない  
traceroute（tracert）は Windows の場合は ICMP だが、linux の場合は UDP で送っているなど違いが存在する  
:::

### 5.7 IP トンネリング
